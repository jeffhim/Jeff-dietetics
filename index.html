<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Dietetic Calculator</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Dietetic Calculator">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#007aff">
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cellipse cx='50' cy='70' rx='40' ry='18' fill='%238B5A2B'/%3E%3Cellipse cx='50' cy='65' rx='38' ry='16' fill='%23A0522D'/%3E%3Cellipse cx='50' cy='50' rx='42' ry='22' fill='%2390EE90'/%3E%3Cellipse cx='50' cy='48' rx='38' ry='18' fill='%2398FB98'/%3E%3Cellipse cx='35' cy='45' rx='12' ry='8' fill='%23228B22'/%3E%3Cellipse cx='55' cy='42' rx='14' ry='9' fill='%2332CD32'/%3E%3Cellipse cx='70' cy='48' rx='10' ry='7' fill='%23228B22'/%3E%3Cellipse cx='45' cy='38' rx='11' ry='7' fill='%233CB371'/%3E%3Ccircle cx='62' cy='40' r='8' fill='%23FF6347'/%3E%3Cellipse cx='62' cy='37' rx='3' ry='1.5' fill='%23228B22'/%3E%3Cellipse cx='30' cy='50' rx='6' ry='3' fill='%23FFA500' transform='rotate(-20 30 50)'/%3E%3Cellipse cx='72' cy='52' rx='5' ry='2.5' fill='%23FFA500' transform='rotate(15 72 52)'/%3E%3Cellipse cx='48' cy='52' rx='7' ry='4' fill='%2390EE90'/%3E%3Cellipse cx='48' cy='52' rx='5' ry='2.5' fill='%23F0FFF0'/%3E%3C/svg%3E">
  <link rel="apple-touch-icon" sizes="180x180" href="https://jeffhim.github.io/Jeff-dietetics/apple-touch-icon.png">
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=SF+Pro+Text:wght@400;500;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #f2f2f7;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e5e5ea;
      --text-primary: #1c1c1e;
      --text-secondary: #8e8e93;
      --accent: #007aff;
      --accent-light: rgba(0, 122, 255, 0.1);
      --success: #34c759;
      --warning: #ff9500;
      --danger: #ff3b30;
      --card-shadow: 0 2px 10px rgba(0,0,0,0.08);
      --border-color: rgba(60,60,67,0.12);
      --pink: #ff2d55;
      --purple: #af52de;
      --teal: #5ac8fa;
    }
    .dark {
      --bg-primary: #000000;
      --bg-secondary: #1c1c1e;
      --bg-tertiary: #2c2c2e;
      --text-primary: #ffffff;
      --text-secondary: #8e8e93;
      --border-color: rgba(255,255,255,0.1);
      --card-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      padding-bottom: calc(90px + env(safe-area-inset-bottom));
      padding-top: env(safe-area-inset-top);
      overflow-x: hidden;
    }
    .header {
      background: var(--bg-secondary);
      padding: 50px 20px 15px;
      padding-top: calc(env(safe-area-inset-top) + 15px);
      border-bottom: 1px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header h1 { font-size: 28px; font-weight: 700; letter-spacing: -0.5px; }
    .header-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
    .tab-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: space-around;
      padding: 8px 0 25px;
      padding-bottom: calc(env(safe-area-inset-bottom) + 8px);
      z-index: 1000;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .tab-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      transition: color 0.2s;
      padding: 5px 15px;
    }
    .tab-item.active { color: var(--accent); }
    .tab-item i { font-size: 22px; }
    .tab-content { display: none; padding: 20px; animation: fadeIn 0.3s ease; }
    .tab-content.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .card { background: var(--bg-secondary); border-radius: 16px; padding: 20px; margin-bottom: 16px; box-shadow: var(--card-shadow); }
    .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
    .card-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; }
    .card-icon.blue { background: linear-gradient(135deg, #007aff, #5856d6); }
    .card-icon.green { background: linear-gradient(135deg, #34c759, #30d158); }
    .card-icon.orange { background: linear-gradient(135deg, #ff9500, #ff6b00); }
    .card-icon.pink { background: linear-gradient(135deg, #ff2d55, #ff375f); }
    .card-icon.purple { background: linear-gradient(135deg, #af52de, #bf5af2); }
    .card-icon.teal { background: linear-gradient(135deg, #5ac8fa, #64d2ff); }
    .card-title { font-size: 17px; font-weight: 600; }
    .card-subtitle { font-size: 13px; color: var(--text-secondary); }
    .input-group { margin-bottom: 14px; }
    .input-label { font-size: 13px; font-weight: 500; color: var(--text-secondary); margin-bottom: 6px; display: block; }
    .input-field { width: 100%; padding: 14px 16px; border: 1px solid var(--border-color); border-radius: 12px; font-size: 16px; background: var(--bg-primary); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; }
    .input-field:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .input-row.three { grid-template-columns: 1fr 1fr 1fr; }
    .segment-control { display: flex; background: var(--bg-tertiary); border-radius: 10px; padding: 3px; margin-bottom: 14px; }
    .segment-btn { flex: 1; padding: 10px; border: none; background: transparent; border-radius: 8px; font-size: 14px; font-weight: 500; color: var(--text-primary); cursor: pointer; transition: all 0.2s; }
    .segment-btn.active { background: var(--bg-secondary); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .btn { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:active { transform: scale(0.98); opacity: 0.9; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); }
    .result-box { background: linear-gradient(135deg, var(--accent-light), rgba(88, 86, 214, 0.1)); border-radius: 14px; padding: 18px; margin-top: 16px; }
    .result-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
    .result-item { text-align: center; padding: 12px; background: var(--bg-secondary); border-radius: 12px; }
    .result-value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .result-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
    .result-item.full { grid-column: span 2; }
    .section-divider { height: 1px; background: var(--border-color); margin: 20px 0; }
    .formula-note { margin-top: 14px; padding: 10px 14px; background: var(--bg-tertiary); border-radius: 10px; color: var(--text-secondary); }
    .formula-note small { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .conversion-section { margin-bottom: 8px; }
    .conversion-section > .input-label { font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .ref-display { background: linear-gradient(135deg, rgba(0, 122, 255, 0.08), rgba(88, 86, 214, 0.08)); border-radius: 12px; padding: 14px; margin-bottom: 8px; }
    .ref-header { font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
    .ref-grid { display: flex; flex-direction: column; gap: 8px; }
    .ref-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-secondary); border-radius: 8px; }
    .ref-label { font-size: 13px; color: var(--text-secondary); }
    .ref-value { font-size: 14px; font-weight: 600; color: var(--accent); }
    .info-table { margin-bottom: 8px; }
    .info-table-header { font-size: 13px; font-weight: 600; color: var(--text-primary); margin-bottom: 10px; padding-left: 4px; }
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; background: var(--bg-primary); border-radius: 10px; overflow: hidden; }
    .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
    .data-table th { background: var(--bg-tertiary); font-weight: 600; font-size: 12px; color: var(--text-secondary); }
    .data-table tr:last-child td { border-bottom: none; }
    .table-note { font-size: 12px; color: var(--accent); padding: 8px 12px; font-style: italic; }
    .highlight-box { background: linear-gradient(135deg, var(--accent-light), rgba(90, 200, 250, 0.15)); padding: 14px 16px; border-radius: 10px; font-size: 15px; font-weight: 600; color: var(--accent); text-align: center; }
    .info-list { background: var(--bg-primary); border-radius: 12px; padding: 14px 16px; }
    .info-list-header { font-size: 13px; font-weight: 600; margin-bottom: 10px; color: var(--text-primary); }
    .info-list ul { margin: 0; padding-left: 20px; font-size: 13px; line-height: 1.8; color: var(--text-secondary); }
    .info-list li strong { color: var(--text-primary); }
    .status-indicator { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; border-radius: 20px; font-size: 13px; font-weight: 500; margin-top: 10px; }
    .status-indicator.normal { background: rgba(52, 199, 89, 0.15); color: var(--success); }
    .status-indicator.warning { background: rgba(255, 149, 0, 0.15); color: var(--warning); }
    .supplement-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg-primary); border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; }
    .supplement-info { flex: 1; }
    .supplement-name { font-weight: 600; font-size: 15px; }
    .supplement-amount { font-size: 13px; color: var(--text-secondary); }
    .supplement-actions { display: flex; gap: 8px; }
    .action-btn { width: 36px; height: 36px; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .action-btn.edit { background: var(--accent-light); color: var(--accent); }
    .action-btn.delete { background: rgba(255, 59, 48, 0.1); color: var(--danger); }
    .nutrient-summary { background: linear-gradient(135deg, rgba(52, 199, 89, 0.1), rgba(90, 200, 250, 0.1)); border-radius: 14px; padding: 20px; margin-top: 16px; }
    .nutrient-summary h4 { font-size: 15px; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .nutrient-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .nutrient-item { text-align: center; padding: 12px 8px; background: var(--bg-secondary); border-radius: 10px; }
    .nutrient-value { font-size: 18px; font-weight: 700; color: var(--success); }
    .nutrient-name { font-size: 11px; color: var(--text-secondary); margin-top: 2px; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px; }
    .modal-overlay.active { display: flex; }
    .modal { background: var(--bg-secondary); border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-title { font-size: 20px; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; border-radius: 50%; background: var(--bg-tertiary); border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
    .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    .clinical-list { margin-top: 10px; }
    .clinical-item { background: var(--bg-primary); border-radius: 12px; padding: 14px 16px; margin-bottom: 10px; cursor: pointer; }
    .clinical-header { display: flex; justify-content: space-between; align-items: center; }
    .clinical-name { font-weight: 600; font-size: 15px; }
    .clinical-chevron { color: var(--text-secondary); transition: transform 0.3s; }
    .clinical-item.expanded .clinical-chevron { transform: rotate(180deg); }
    .clinical-details { display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
    .clinical-item.expanded .clinical-details { display: block; }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-logo">
      <svg viewBox="0 0 100 100" width="48" height="48" style="margin-bottom: 8px;">
        <!-- Bowl -->
        <ellipse cx="50" cy="70" rx="40" ry="18" fill="#8B5A2B"/>
        <ellipse cx="50" cy="65" rx="38" ry="16" fill="#A0522D"/>
        <ellipse cx="50" cy="50" rx="42" ry="22" fill="#90EE90"/>
        <ellipse cx="50" cy="48" rx="38" ry="18" fill="#98FB98"/>
        <!-- Salad greens -->
        <ellipse cx="35" cy="45" rx="12" ry="8" fill="#228B22"/>
        <ellipse cx="55" cy="42" rx="14" ry="9" fill="#32CD32"/>
        <ellipse cx="70" cy="48" rx="10" ry="7" fill="#228B22"/>
        <ellipse cx="45" cy="38" rx="11" ry="7" fill="#3CB371"/>
        <!-- Tomato -->
        <circle cx="62" cy="40" r="8" fill="#FF6347"/>
        <ellipse cx="62" cy="37" rx="3" ry="1.5" fill="#228B22"/>
        <!-- Carrot pieces -->
        <ellipse cx="30" cy="50" rx="6" ry="3" fill="#FFA500" transform="rotate(-20 30 50)"/>
        <ellipse cx="72" cy="52" rx="5" ry="2.5" fill="#FFA500" transform="rotate(15 72 52)"/>
        <!-- Cucumber -->
        <ellipse cx="48" cy="52" rx="7" ry="4" fill="#90EE90"/>
        <ellipse cx="48" cy="52" rx="5" ry="2.5" fill="#F0FFF0"/>
        <!-- Bowl rim highlight -->
        <ellipse cx="50" cy="58" rx="36" ry="4" fill="rgba(255,255,255,0.2)"/>
      </svg>
    </div>
    <h1>Dietetic Calculator</h1>
    <p class="header-subtitle">My dietitian assistant</p>
  </div>

  <!-- Tab 1: Adult -->
  <div id="tab-adult" class="tab-content active">
    <div class="card">
      <div class="card-header">
        <div class="card-icon blue"><i class="fas fa-weight"></i></div>
        <div>
          <div class="card-title">BMI & Adjusted Body Weight</div>
          <div class="card-subtitle">Calculate from actual measurements</div>
        </div>
      </div>
      <div class="input-row three">
        <div class="input-group">
          <label class="input-label">Weight (kg)</label>
          <input type="number" class="input-field" id="actual-weight" placeholder="70 (optional)" step="0.1" oninput="calculateBMIAndABW()">
        </div>
        <div class="input-group">
          <label class="input-label">Height (cm)</label>
          <input type="number" class="input-field" id="actual-height" placeholder="170" step="0.1" oninput="calculateBMIAndABW()">
        </div>
        <div class="input-group">
          <label class="input-label">Ideal BMI</label>
          <input type="number" class="input-field" id="ideal-bmi" placeholder="21.7" value="21.7" step="0.1" oninput="calculateBMIAndABW()">
        </div>
      </div>
      <div id="bmi-abw-results" class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="res-actual-bmi">--</div><div class="result-label">Actual BMI (kg/m²)</div></div>
          <div class="result-item"><div class="result-value" id="res-ideal-bw">--</div><div class="result-label">Ideal Body Weight (kg)</div></div>
          <div class="result-item full"><div class="result-value" id="res-adjusted-bw">--</div><div class="result-label">Adjusted Body Weight (kg)</div></div>
        </div>
        <div class="formula-note"><small><i class="fas fa-info-circle"></i> ABW = Ideal BW + (Actual BW − Ideal BW) ÷ 4</small></div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon green"><i class="fas fa-balance-scale"></i></div>
        <div>
          <div class="card-title">Estimate Body Weight</div>
          <div class="card-subtitle">Calculate weight from BMI & height</div>
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Estimated BMI</label>
          <input type="number" class="input-field" id="est-bmi" placeholder="22" step="0.1" oninput="calculateEstWeight()">
        </div>
        <div class="input-group">
          <label class="input-label">Height (cm)</label>
          <input type="number" class="input-field" id="est-height" placeholder="170" step="0.1" oninput="calculateEstWeight()">
        </div>
      </div>
      <div id="est-weight-results" class="result-box">
        <div class="result-grid">
          <div class="result-item full"><div class="result-value" id="res-est-weight">--</div><div class="result-label">Estimated Body Weight (kg)</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon purple"><i class="fas fa-exchange-alt"></i></div>
        <div>
          <div class="card-title">Unit Conversion</div>
          <div class="card-subtitle">Pounds ↔ kg, Feet/Inches ↔ cm</div>
        </div>
      </div>
      <div class="conversion-section">
        <label class="input-label"><i class="fas fa-weight-hanging"></i> Weight Conversion</label>
        <div class="input-row">
          <div class="input-group">
            <label class="input-label">Pounds (lb)</label>
            <input type="number" class="input-field" id="conv-pounds" placeholder="150" step="0.1" oninput="convertPoundsToKg()">
          </div>
          <div class="input-group">
            <label class="input-label">Kilograms (kg)</label>
            <input type="number" class="input-field" id="conv-kg" placeholder="68" step="0.1" oninput="convertKgToPounds()">
          </div>
        </div>
      </div>
      <div class="section-divider"></div>
      <div class="conversion-section">
        <label class="input-label"><i class="fas fa-ruler-vertical"></i> Height Conversion</label>
        <div class="input-row three">
          <div class="input-group">
            <label class="input-label">Feet</label>
            <input type="number" class="input-field" id="conv-feet" placeholder="5" step="1" oninput="convertFeetInchesToCm()">
          </div>
          <div class="input-group">
            <label class="input-label">Inches</label>
            <input type="number" class="input-field" id="conv-inches" placeholder="7" step="0.1" oninput="convertFeetInchesToCm()">
          </div>
          <div class="input-group">
            <label class="input-label">Centimeters</label>
            <input type="number" class="input-field" id="conv-cm" placeholder="170" step="0.1" oninput="convertCmToFeetInches()">
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon orange"><i class="fas fa-fire"></i></div>
        <div>
          <div class="card-title">Energy & Protein Requirements</div>
          <div class="card-subtitle">Real-time calculation × Body Weight</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Body Weight for Calculation (kg)</label>
        <input type="number" class="input-field" id="req-body-weight" placeholder="Use ABW from above" step="0.1" oninput="calculateRequirementsRealtime()">
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Energy Factor (kcal/kg)</label>
          <input type="number" class="input-field" id="energy-factor" placeholder="25-35" step="0.1" oninput="calculateRequirementsRealtime()">
        </div>
        <div class="input-group">
          <label class="input-label">Protein Factor (g/kg)</label>
          <input type="number" class="input-field" id="protein-factor" placeholder="0.8-2.0" step="0.1" oninput="calculateRequirementsRealtime()">
        </div>
      </div>
      <div id="req-results" class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="res-energy-req">--</div><div class="result-label">Energy (kcal/day)</div></div>
          <div class="result-item"><div class="result-value" id="res-protein-req">--</div><div class="result-label">Protein (g/day)</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 2: Pediatrics -->
  <div id="tab-peds" class="tab-content">
    <div class="card">
      <div class="card-header">
        <div class="card-icon purple"><i class="fas fa-baby"></i></div>
        <div>
          <div class="card-title">Growth Percentile Calculator</div>
          <div class="card-subtitle">HK Growth Study 2020 Reference</div>
        </div>
      </div>
      <div class="segment-control">
        <button class="segment-btn active" onclick="setPedGender('male')">Boy</button>
        <button class="segment-btn" onclick="setPedGender('female')">Girl</button>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Age</label>
          <input type="number" class="input-field" id="ped-age" placeholder="5" step="0.1" oninput="calculateGrowthPercentiles()">
        </div>
        <div class="input-group">
          <label class="input-label">Age Unit</label>
          <select class="input-field" id="ped-age-unit" onchange="calculateGrowthPercentiles()">
            <option value="months">Months</option>
            <option value="years">Years</option>
          </select>
        </div>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Weight (kg)</label>
          <input type="number" class="input-field" id="ped-weight" placeholder="20" step="0.1" oninput="calculateGrowthPercentiles()">
        </div>
        <div class="input-group">
          <label class="input-label">Height (cm)</label>
          <input type="number" class="input-field" id="ped-height" placeholder="110" step="0.1" oninput="calculateGrowthPercentiles()">
        </div>
      </div>

      <div id="ped-results" class="result-box">
        <div class="result-grid">
          <div class="result-item">
            <div class="result-value" id="ped-bmi-val">--</div>
            <div class="result-label">BMI (kg/m²)</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="ped-ref-weight">--</div>
            <div class="result-label">Ref Weight P50 (kg)</div>
          </div>
        </div>

        <div class="section-divider" style="margin: 14px 0;"></div>
        <div class="ref-header">Weight-for-Age Percentile</div>
        <div class="result-grid" style="margin-bottom: 12px;">
          <div class="result-item">
            <div class="result-value" id="wt-exact-centile">--</div>
            <div class="result-label">Exact Centile</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="wt-range-centile" style="font-size: 18px;">--</div>
            <div class="result-label">Centile Range</div>
          </div>
        </div>

        <div class="ref-header">Height-for-Age Percentile</div>
        <div class="result-grid" style="margin-bottom: 12px;">
          <div class="result-item">
            <div class="result-value" id="ht-exact-centile">--</div>
            <div class="result-label">Exact Centile</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="ht-range-centile" style="font-size: 18px;">--</div>
            <div class="result-label">Centile Range</div>
          </div>
        </div>

        <div class="ref-header">BMI-for-Age Percentile</div>
        <div class="result-grid">
          <div class="result-item">
            <div class="result-value" id="bmi-exact-centile">--</div>
            <div class="result-label">Exact Centile</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="bmi-range-centile" style="font-size: 18px;">--</div>
            <div class="result-label">Centile Range</div>
          </div>
        </div>
        <div id="growth-status" style="text-align: center; margin-top: 12px;"></div>
      </div>
      <div class="formula-note" style="margin-top: 12px;">
        <small><i class="fas fa-info-circle"></i> HK Growth Study 2020 centiles: 0.4, 2, 9, 25, 50, 75, 91, 98, 99.6</small>
      </div>
    </div>

    <!-- Energy, Protein, Fluid Requirements -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon orange"><i class="fas fa-fire"></i></div>
        <div>
          <div class="card-title">Energy, Protein & Fluid</div>
          <div class="card-subtitle">Reference values & custom calculation</div>
        </div>
      </div>
      <div class="ref-display" id="ped-ref-display">
        <div class="ref-header">Reference Values (based on age & sex)</div>
        <div class="ref-grid">
          <div class="ref-item"><span class="ref-label">Energy:</span><span class="ref-value" id="ref-energy-val">--</span></div>
          <div class="ref-item"><span class="ref-label">Protein:</span><span class="ref-value" id="ref-protein-val">--</span></div>
          <div class="ref-item"><span class="ref-label">Fluid:</span><span class="ref-value" id="ref-fluid-val">--</span></div>
        </div>
      </div>
      <div class="section-divider"></div>
      <div class="input-row three">
        <div class="input-group">
          <label class="input-label">Energy (kcal/kg)</label>
          <input type="number" class="input-field" id="ped-energy-factor" placeholder="e.g. 80" step="1" oninput="calculatePedRealtime()">
        </div>
        <div class="input-group">
          <label class="input-label">Protein (g/kg)</label>
          <input type="number" class="input-field" id="ped-protein-factor" placeholder="e.g. 1.5" step="0.1" oninput="calculatePedRealtime()">
        </div>
        <div class="input-group">
          <label class="input-label">Fluid (mL/kg)</label>
          <input type="number" class="input-field" id="ped-fluid-factor" placeholder="e.g. 120" step="1" oninput="calculatePedRealtime()">
        </div>
      </div>
      <div id="ped-req-results" class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="ped-energy-result">--</div><div class="result-label">Energy (kcal/day)</div></div>
          <div class="result-item"><div class="result-value" id="ped-protein-result">--</div><div class="result-label">Protein (g/day)</div></div>
          <div class="result-item full"><div class="result-value" id="ped-fluid-result">--</div><div class="result-label">Fluid (mL/day)</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 3: Supplements -->
  <div id="tab-supplements" class="tab-content">
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 12px 16px; border-radius: 10px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);">
      <i class="fas fa-tools" style="font-size: 18px;"></i>
      <span style="font-weight: 600;">Work in Progress</span>
    </div>
    <div class="card">
      <div class="card-header">
        <div class="card-icon green"><i class="fas fa-prescription-bottle"></i></div>
        <div>
          <div class="card-title">Milk Supplements</div>
          <div class="card-subtitle">Add and calculate nutrition</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Select Supplement</label>
        <select class="input-field" id="supplement-select"></select>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Amount (mL)</label>
          <input type="number" class="input-field" id="supplement-amount" placeholder="100">
        </div>
        <div class="input-group">
          <label class="input-label">&nbsp;</label>
          <button class="btn btn-primary" onclick="addSupplement()"><i class="fas fa-plus"></i> Add</button>
        </div>
      </div>
      <div class="supplement-list" id="supplement-list">
        <div class="empty-state"><i class="fas fa-flask"></i><p>No supplements added yet</p></div>
      </div>
    </div>
    <div class="card" id="nutrition-summary-card" style="display: none;">
      <div class="card-header">
        <div class="card-icon orange"><i class="fas fa-chart-pie"></i></div>
        <div>
          <div class="card-title">Total Nutrition</div>
          <div class="card-subtitle">Combined supplement values</div>
        </div>
      </div>
      <div class="nutrient-summary"><h4><i class="fas fa-fire"></i> Macronutrients</h4><div class="nutrient-grid" id="macro-grid"></div></div>
      <button class="btn btn-secondary" style="margin-top: 16px;" onclick="clearAllSupplements()"><i class="fas fa-trash"></i> Clear All</button>
    </div>
  </div>

  <div class="modal-overlay" id="edit-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Edit Amount</h3>
        <button class="modal-close" onclick="closeModal()"><i class="fas fa-times"></i></button>
      </div>
      <div class="input-group">
        <label class="input-label">Amount (mL)</label>
        <input type="number" class="input-field" id="edit-amount">
      </div>
      <button class="btn btn-primary" onclick="saveEdit()">Save</button>
    </div>
  </div>

  <!-- Tab 4: Ped Milk -->
  <div id="tab-pedmilk" class="tab-content">
    <!-- Formula 1 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon pink"><i class="fas fa-baby-carriage"></i></div>
        <div>
          <div class="card-title">Formula 1</div>
          <div class="card-subtitle">Nutrition calculator</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Select Formula</label>
        <select class="input-field" id="formula-select-1" onchange="updateFormulaInfo(1)">
          <option value="">-- Select Formula --</option>
        </select>
      </div>
      <div id="formula-info-1" class="ref-display" style="display: none;">
        <div class="ref-header">Formula Information (per 100mL)</div>
        <div class="ref-grid">
          <div class="ref-item"><span class="ref-label">Energy:</span><span class="ref-value" id="formula-energy-1">--</span></div>
          <div class="ref-item"><span class="ref-label">Protein:</span><span class="ref-value" id="formula-protein-1">--</span></div>
          <div class="ref-item"><span class="ref-label">Fat:</span><span class="ref-value" id="formula-fat-1">--</span></div>
          <div class="ref-item"><span class="ref-label">Std Dilution:</span><span class="ref-value" id="formula-dilution-1">--</span></div>
        </div>
      </div>
      <div class="section-divider"></div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Volume (mL)</label>
          <input type="number" class="input-field" id="formula-volume-1" placeholder="e.g. 150" step="1" oninput="calculateFormulaNutrition(1)">
        </div>
        <div class="input-group">
          <label class="input-label">Strength</label>
          <input type="number" class="input-field" id="formula-strength-1" placeholder="1.0" step="0.05" value="1.0" oninput="calculateFormulaNutrition(1)">
        </div>
        <div class="input-group">
          <label class="input-label">Frequency</label>
          <input type="number" class="input-field" id="formula-freq-1" placeholder="e.g. 6" step="1" min="1" value="1" oninput="calculateFormulaNutrition(1)">
        </div>
      </div>
      <div id="formula-nutrition-results-1" class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="formula-kcal-result-1">--</div><div class="result-label">Energy (kcal)</div></div>
          <div class="result-item"><div class="result-value" id="formula-protein-result-1">--</div><div class="result-label">Protein (g)</div></div>
          <div class="result-item"><div class="result-value" id="formula-fat-result-1">--</div><div class="result-label">Fat (g)</div></div>
          <div class="result-item"><div class="result-value" id="formula-carb-result-1">--</div><div class="result-label">Carbs (g)</div></div>
        </div>
      </div>
    </div>

    <!-- Formula 2 -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon purple"><i class="fas fa-baby-carriage"></i></div>
        <div>
          <div class="card-title">Formula 2</div>
          <div class="card-subtitle">Nutrition calculator</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Select Formula</label>
        <select class="input-field" id="formula-select-2" onchange="updateFormulaInfo(2)">
          <option value="">-- Select Formula --</option>
        </select>
      </div>
      <div id="formula-info-2" class="ref-display" style="display: none;">
        <div class="ref-header">Formula Information (per 100mL)</div>
        <div class="ref-grid">
          <div class="ref-item"><span class="ref-label">Energy:</span><span class="ref-value" id="formula-energy-2">--</span></div>
          <div class="ref-item"><span class="ref-label">Protein:</span><span class="ref-value" id="formula-protein-2">--</span></div>
          <div class="ref-item"><span class="ref-label">Fat:</span><span class="ref-value" id="formula-fat-2">--</span></div>
          <div class="ref-item"><span class="ref-label">Std Dilution:</span><span class="ref-value" id="formula-dilution-2">--</span></div>
        </div>
      </div>
      <div class="section-divider"></div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Volume (mL)</label>
          <input type="number" class="input-field" id="formula-volume-2" placeholder="e.g. 150" step="1" oninput="calculateFormulaNutrition(2)">
        </div>
        <div class="input-group">
          <label class="input-label">Strength</label>
          <input type="number" class="input-field" id="formula-strength-2" placeholder="1.0" step="0.05" value="1.0" oninput="calculateFormulaNutrition(2)">
        </div>
        <div class="input-group">
          <label class="input-label">Frequency</label>
          <input type="number" class="input-field" id="formula-freq-2" placeholder="e.g. 6" step="1" min="1" value="1" oninput="calculateFormulaNutrition(2)">
        </div>
      </div>
      <div id="formula-nutrition-results-2" class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="formula-kcal-result-2">--</div><div class="result-label">Energy (kcal)</div></div>
          <div class="result-item"><div class="result-value" id="formula-protein-result-2">--</div><div class="result-label">Protein (g)</div></div>
          <div class="result-item"><div class="result-value" id="formula-fat-result-2">--</div><div class="result-label">Fat (g)</div></div>
          <div class="result-item"><div class="result-value" id="formula-carb-result-2">--</div><div class="result-label">Carbs (g)</div></div>
        </div>
      </div>
    </div>

    <!-- Combined Total -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon green"><i class="fas fa-plus-circle"></i></div>
        <div>
          <div class="card-title">Combined Total</div>
          <div class="card-subtitle">Formula 1 + Formula 2</div>
        </div>
      </div>
      <div class="result-box">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="combined-volume">--</div><div class="result-label">Total Volume (mL)</div></div>
          <div class="result-item"><div class="result-value" id="combined-kcal">--</div><div class="result-label">Energy (kcal)</div></div>
          <div class="result-item"><div class="result-value" id="combined-protein">--</div><div class="result-label">Protein (g)</div></div>
          <div class="result-item"><div class="result-value" id="combined-carbs">--</div><div class="result-label">Carbs (g)</div></div>
          <div class="result-item"><div class="result-value" id="combined-fat">--</div><div class="result-label">Fat (g)</div></div>
          <div class="result-item"><div class="result-value" id="combined-kcal-per-100">--</div><div class="result-label">kcal/100mL</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon orange"><i class="fas fa-blender"></i></div>
        <div>
          <div class="card-title">Custom Strength Calculator</div>
          <div class="card-subtitle">Calculate scoop & water for target strength</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Select Formula</label>
        <select class="input-field" id="strength-formula-select" onchange="calculateCustomStrength()">
          <option value="">-- Select Formula --</option>
        </select>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Target Strength</label>
          <input type="number" class="input-field" id="target-strength" placeholder="e.g. 1.1" step="0.05" value="1.0" oninput="calculateCustomStrength()">
        </div>
        <div class="input-group">
          <label class="input-label">Target Volume (mL)</label>
          <input type="number" class="input-field" id="target-volume" placeholder="e.g. 150" step="1" oninput="calculateCustomStrength()">
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Dilution Factor (÷)</label>
        <select class="input-field" id="dilution-factor" onchange="calculateCustomStrength()">
          <option value="1">None (Standard)</option>
          <option value="0.9">÷ 0.9</option>
          <option value="0.84">÷ 0.84</option>
        </select>
      </div>
      <div id="custom-strength-result" class="result-box" style="display: none;">
        <div class="highlight-box" id="strength-instruction">--</div>
        <div class="ref-display" style="margin-top: 12px;">
          <div class="ref-header">Calculation Details</div>
          <div class="ref-grid">
            <div class="ref-item"><span class="ref-label">Scoops needed:</span><span class="ref-value" id="scoops-needed">--</span></div>
            <div class="ref-item"><span class="ref-label">Water (mL):</span><span class="ref-value" id="water-needed">--</span></div>
            <div class="ref-item"><span class="ref-label">Final kcal/100mL:</span><span class="ref-value" id="final-kcal">--</span></div>
          </div>
        </div>
      </div>
      <div class="formula-note" style="margin-top: 12px;">
        <small><i class="fas fa-info-circle"></i> Standard dilution: 1 scoop powder + water to make final volume</small>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon teal"><i class="fas fa-calculator"></i></div>
        <div>
          <div class="card-title">Reverse Calculator</div>
          <div class="card-subtitle">Input scoops & water → get volume & nutrition</div>
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Select Formula</label>
        <select class="input-field" id="reverse-formula-select" onchange="calculateReverseNutrition()">
          <option value="">-- Select Formula --</option>
        </select>
      </div>
      <div class="input-row">
        <div class="input-group">
          <label class="input-label">Number of Scoops</label>
          <input type="number" class="input-field" id="reverse-scoops" placeholder="e.g. 5" step="0.1" oninput="calculateReverseNutrition()">
        </div>
        <div class="input-group">
          <label class="input-label">Water Added (mL)</label>
          <input type="number" class="input-field" id="reverse-water" placeholder="e.g. 135" step="1" oninput="calculateReverseNutrition()">
        </div>
      </div>
      <div class="input-group">
        <label class="input-label">Expansion Factor (÷)</label>
        <select class="input-field" id="reverse-expansion" onchange="calculateReverseNutrition()">
          <option value="1">None (Standard)</option>
          <option value="0.9">÷ 0.9</option>
          <option value="0.84">÷ 0.84</option>
        </select>
      </div>
      <div id="reverse-results" class="result-box" style="display: none;">
        <div class="result-grid">
          <div class="result-item"><div class="result-value" id="reverse-volume">--</div><div class="result-label">Final Volume (mL)</div></div>
          <div class="result-item"><div class="result-value" id="reverse-strength">--</div><div class="result-label">Strength</div></div>
          <div class="result-item"><div class="result-value" id="reverse-kcal">--</div><div class="result-label">Energy (kcal)</div></div>
          <div class="result-item"><div class="result-value" id="reverse-protein">--</div><div class="result-label">Protein (g)</div></div>
          <div class="result-item"><div class="result-value" id="reverse-carbs">--</div><div class="result-label">Carbs (g)</div></div>
          <div class="result-item"><div class="result-value" id="reverse-fat">--</div><div class="result-label">Fat (g)</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 5: Keto -->
  <div id="tab-keto" class="tab-content">
    <!-- Basic KD Calculator -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon purple"><i class="fas fa-fire-flame-curved"></i></div>
        <div>
          <div class="card-title">Classic Ketogenic Diet</div>
          <div class="card-subtitle">Fat : (CHO + Protein) ratio calculator</div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Energy Requirement (kcal/day)</label>
        <input type="number" class="input-field" id="keto-energy" placeholder="e.g. 1600" oninput="calculateKeto()">
      </div>

      <div class="input-group">
        <label class="input-label">Protein Requirement (g/day)</label>
        <input type="number" class="input-field" id="keto-protein" placeholder="e.g. 75" oninput="calculateKeto()">
      </div>

      <div class="input-group">
        <label class="input-label">KD Ratio (Fat : CHO+Pro)</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <input type="number" class="input-field" id="keto-ratio-fat" placeholder="Fat" step="0.1" min="0.1" oninput="calculateKeto()" style="flex: 1; text-align: center;">
          <span style="font-weight: 600; color: var(--text-secondary); font-size: 18px;">:</span>
          <input type="number" class="input-field" id="keto-ratio-pro" placeholder="CHO+Pro" step="0.1" min="0.1" value="1" oninput="calculateKeto()" style="flex: 1; text-align: center;">
        </div>
      </div>

      <div id="keto-results" class="result-box" style="display: none;">
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
          <i class="fas fa-calculator"></i> Calculation Steps
        </div>
        <div style="background: var(--bg-secondary); border-radius: 10px; padding: 12px; margin-bottom: 14px; font-size: 13px; color: var(--text-secondary);">
          <div id="keto-steps"></div>
        </div>

        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
          <i class="fas fa-utensils"></i> Daily Prescription
        </div>
        <div class="result-grid">
          <div class="result-item">
            <div class="result-value" id="keto-result-fat">--</div>
            <div class="result-label">Fat (g)</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="keto-result-protein">--</div>
            <div class="result-label">Protein (g)</div>
          </div>
          <div class="result-item full">
            <div class="result-value" id="keto-result-cho">--</div>
            <div class="result-label">CHO (g)</div>
          </div>
        </div>

        <div id="keto-warning" class="formula-note" style="margin-top: 14px; display: none; background: rgba(255, 59, 48, 0.1);">
          <small style="color: var(--danger);"><i class="fas fa-exclamation-triangle"></i> <span id="keto-warning-text"></span></small>
        </div>
      </div>
    </div>

    <!-- Ketocal 4:1 Calculator -->
    <div class="card">
      <div class="card-header">
        <div class="card-icon orange"><i class="fas fa-flask"></i></div>
        <div>
          <div class="card-title">Ketocal 4:1 Calculator</div>
          <div class="card-subtitle">Calculate Ketocal amount & adjustments</div>
        </div>
      </div>

      <div class="input-group">
        <label class="input-label">Ketocal 4:1 Strength (%)</label>
        <input type="number" class="input-field" id="ketocal-strength" placeholder="e.g. 100" value="100" min="1" max="200" oninput="updateKetocalInfo(); calculateKeto();">
      </div>

      <div class="info-list" style="margin-bottom: 16px;">
        <div class="info-list-header"><i class="fas fa-info-circle"></i> Ketocal 4:1 per 100ml (at <span id="ketocal-strength-display">100</span>%)</div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 8px;">
          <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="font-weight: 600; color: var(--accent);" id="ketocal-info-kcal">100</div>
            <div style="font-size: 11px; color: var(--text-secondary);">kcal</div>
          </div>
          <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="font-weight: 600; color: var(--accent);" id="ketocal-info-fat">9.8</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Fat (g)</div>
          </div>
          <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="font-weight: 600; color: var(--accent);" id="ketocal-info-pro">2.0</div>
            <div style="font-size: 11px; color: var(--text-secondary);">Pro (g)</div>
          </div>
          <div style="text-align: center; padding: 8px; background: var(--bg-tertiary); border-radius: 8px;">
            <div style="font-weight: 600; color: var(--accent);" id="ketocal-info-cho">0.4</div>
            <div style="font-size: 11px; color: var(--text-secondary);">CHO (g)</div>
          </div>
        </div>
      </div>

      <div id="ketocal-results" class="result-box" style="display: none;">
        <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">
          <i class="fas fa-prescription-bottle"></i> Ketocal 4:1 Prescription
        </div>

        <div class="result-grid" style="margin-bottom: 14px;">
          <div class="result-item full">
            <div class="result-value" id="ketocal-amount">--</div>
            <div class="result-label">Ketocal 4:1 (ml)</div>
          </div>
        </div>

        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Nutrients from Ketocal:</div>
        <div class="result-grid" style="margin-bottom: 14px;">
          <div class="result-item">
            <div class="result-value" id="ketocal-fat">--</div>
            <div class="result-label">Fat (g)</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="ketocal-protein">--</div>
            <div class="result-label">Protein (g)</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="ketocal-cho">--</div>
            <div class="result-label">CHO (g)</div>
          </div>
          <div class="result-item">
            <div class="result-value" id="ketocal-ratio">--</div>
            <div class="result-label">KD Ratio</div>
          </div>
        </div>

        <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);">Adjustments Needed:</div>
        <div class="result-grid">
          <div class="result-item full">
            <div class="result-value" id="ketocal-extra">--</div>
            <div class="result-label">Extra Pro/CHO to add (g)</div>
          </div>
        </div>

        <div class="input-group" style="margin-top: 14px;">
          <label class="input-label">Choose Adjustment Method</label>
          <select class="input-field" id="adjustment-method" onchange="toggleAdjustmentMethod()">
            <option value="beneprotein">Beneprotein (add as protein)</option>
            <option value="polycal">Polycal (add as CHO)</option>
            <option value="nutren">Nutren Junior Powder</option>
          </select>
        </div>

        <!-- Beneprotein Option -->
        <div id="adjustment-beneprotein" class="adjustment-section">
          <div class="result-grid" style="margin-top: 12px;">
            <div class="result-item full">
              <div class="result-value" id="ketocal-beneprotein">--</div>
              <div class="result-label">Beneprotein (g)</div>
            </div>
          </div>
          <div class="formula-note" style="margin-top: 8px;">
            <small><i class="fas fa-lightbulb"></i> Beneprotein: 6g protein per 7g powder</small>
          </div>
        </div>

        <!-- Polycal Option -->
        <div id="adjustment-polycal" class="adjustment-section" style="display: none;">
          <div class="result-grid" style="margin-top: 12px;">
            <div class="result-item full">
              <div class="result-value" id="ketocal-polycal">--</div>
              <div class="result-label">Polycal (g)</div>
            </div>
          </div>
          <div class="formula-note" style="margin-top: 8px;">
            <small><i class="fas fa-lightbulb"></i> Polycal: 0.96g carbohydrates per 1g powder</small>
          </div>
        </div>

        <!-- Nutren Junior Option -->
        <div id="adjustment-nutren" class="adjustment-section" style="display: none;">
          <div class="input-group" style="margin: 12px 0 10px;">
            <label class="input-label">Nutren Junior Strength (%)</label>
            <input type="number" class="input-field" id="nutren-strength" placeholder="e.g. 100" value="100" min="1" max="200" oninput="updateNutrenInfo(); calculateKeto();">
          </div>
          <div class="info-list" style="margin-bottom: 10px;">
            <div class="info-list-header" style="font-size: 11px;"><i class="fas fa-info-circle"></i> Nutren Junior Powder per 100ml (at <span id="nutren-strength-display">100</span>%)</div>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-top: 6px;">
              <div style="text-align: center; padding: 6px; background: var(--bg-tertiary); border-radius: 6px;">
                <div style="font-weight: 600; color: var(--accent); font-size: 12px;" id="nutren-info-kcal">102</div>
                <div style="font-size: 10px; color: var(--text-secondary);">kcal</div>
              </div>
              <div style="text-align: center; padding: 6px; background: var(--bg-tertiary); border-radius: 6px;">
                <div style="font-weight: 600; color: var(--accent); font-size: 12px;" id="nutren-info-fat">4.04</div>
                <div style="font-size: 10px; color: var(--text-secondary);">Fat (g)</div>
              </div>
              <div style="text-align: center; padding: 6px; background: var(--bg-tertiary); border-radius: 6px;">
                <div style="font-weight: 600; color: var(--accent); font-size: 12px;" id="nutren-info-pro">3.04</div>
                <div style="font-size: 10px; color: var(--text-secondary);">Pro (g)</div>
              </div>
              <div style="text-align: center; padding: 6px; background: var(--bg-tertiary); border-radius: 6px;">
                <div style="font-weight: 600; color: var(--accent); font-size: 12px;" id="nutren-info-cho">13.36</div>
                <div style="font-size: 10px; color: var(--text-secondary);">CHO (g)</div>
              </div>
            </div>
          </div>
          <div class="result-grid">
            <div class="result-item full">
              <div class="result-value" id="ketocal-nutren">--</div>
              <div class="result-label">Nutren Junior (ml)</div>
            </div>
          </div>
          <div class="formula-note" style="margin-top: 8px;">
            <small><i class="fas fa-lightbulb"></i> Nutren Junior Powder per 100ml (100%): 102 kcal, 4.04g fat, 3.04g protein, 13.36g CHO</small>
          </div>
        </div>

        <!-- Final Combined Nutrition -->
        <div id="keto-final-nutrition" style="display: none; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-color);">
          <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 10px; display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-blender" style="color: var(--accent);"></i>
            Final Milk Nutrition
          </div>
          <div class="result-grid">
            <div class="result-item">
              <div class="result-value" id="keto-final-kcal">--</div>
              <div class="result-label">Energy (kcal)</div>
            </div>
            <div class="result-item">
              <div class="result-value" id="keto-final-fat">--</div>
              <div class="result-label">Fat (g)</div>
            </div>
            <div class="result-item">
              <div class="result-value" id="keto-final-protein">--</div>
              <div class="result-label">Protein (g)</div>
            </div>
            <div class="result-item">
              <div class="result-value" id="keto-final-cho">--</div>
              <div class="result-label">CHO (g)</div>
            </div>
          </div>
          <div class="result-grid" style="margin-top: 10px;">
            <div class="result-item">
              <div class="result-value" id="keto-final-volume">--</div>
              <div class="result-label">Total Volume (ml)</div>
            </div>
            <div class="result-item">
              <div class="result-value" id="keto-final-ratio">--</div>
              <div class="result-label">Achieved KD Ratio</div>
            </div>
          </div>
          <div class="formula-note" style="margin-top: 10px;">
            <small><i class="fas fa-calculator"></i> <span id="keto-final-composition">--</span></small>
          </div>
          <div id="keto-protein-warning" class="warning-box" style="display: none; margin-top: 12px; padding: 10px 12px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="margin-right: 6px;"></i>
            <span id="keto-protein-warning-text">Protein is below requirement</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tab-bar">
    <div class="tab-item active" onclick="switchTab('adult')"><i class="fas fa-user"></i><span>Adult</span></div>
    <div class="tab-item" onclick="switchTab('peds')"><i class="fas fa-child"></i><span>Pediatric</span></div>
    <div class="tab-item" onclick="switchTab('supplements')"><i class="fas fa-flask"></i><span>Suppl.</span></div>
    <div class="tab-item" onclick="switchTab('pedmilk')"><i class="fas fa-baby-carriage"></i><span>Ped Milk</span></div>
    <div class="tab-item" onclick="switchTab('keto')"><i class="fas fa-fire-flame-curved"></i><span>Keto</span></div>
  </div>

  <script>
    // Dark mode
    if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
      document.documentElement.classList.add('dark');
    }
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
      document.documentElement.classList.toggle('dark', e.matches);
    });

    let pedGender = 'male';
    let addedSupplements = [];
    let editingIndex = -1;

    // HK Growth Study 2020 centile lines
    const centiles = [0.4, 2, 9, 25, 50, 75, 91, 98, 99.6];

    // Reference data for weight, height, BMI by age in months
    const hkData = {
      male: {
        weight: {
          0: [2.2, 2.5, 2.9, 3.2, 3.5, 3.9, 4.2, 4.6, 5.0],
          2: [3.8, 4.2, 4.8, 5.3, 5.8, 6.4, 7.0, 7.6, 8.2],
          4: [5.0, 5.5, 6.2, 6.8, 7.5, 8.2, 8.9, 9.6, 10.3],
          6: [5.9, 6.5, 7.2, 7.9, 8.6, 9.4, 10.2, 11.0, 11.8],
          9: [6.8, 7.5, 8.3, 9.1, 9.9, 10.8, 11.7, 12.6, 13.5],
          12: [7.5, 8.2, 9.1, 10.0, 10.9, 11.8, 12.8, 13.8, 14.8],
          18: [8.5, 9.3, 10.3, 11.3, 12.3, 13.4, 14.5, 15.6, 16.8],
          24: [9.3, 10.2, 11.2, 12.3, 13.5, 14.7, 15.9, 17.2, 18.5],
          36: [11.0, 12.0, 13.2, 14.5, 15.8, 17.2, 18.7, 20.2, 21.8],
          48: [12.5, 13.7, 15.1, 16.6, 18.2, 19.9, 21.7, 23.6, 25.5],
          60: [14.0, 15.3, 16.9, 18.6, 20.5, 22.5, 24.6, 26.9, 29.2],
          72: [15.5, 17.0, 18.8, 20.8, 22.9, 25.2, 27.7, 30.4, 33.2],
          84: [17.0, 18.7, 20.8, 23.0, 25.5, 28.2, 31.1, 34.3, 37.6],
          96: [18.6, 20.5, 22.8, 25.4, 28.2, 31.4, 34.8, 38.5, 42.4],
          108: [20.2, 22.4, 25.0, 28.0, 31.2, 34.9, 38.9, 43.2, 47.8],
          120: [22.0, 24.5, 27.4, 30.8, 34.5, 38.7, 43.3, 48.4, 53.8],
          132: [24.0, 26.8, 30.2, 34.0, 38.2, 43.0, 48.3, 54.2, 60.5],
          144: [26.2, 29.4, 33.2, 37.6, 42.4, 47.9, 54.0, 60.7, 68.0],
          156: [29.0, 32.6, 36.9, 41.8, 47.3, 53.5, 60.4, 68.0, 76.3],
          168: [32.5, 36.5, 41.3, 46.8, 53.0, 60.0, 67.7, 76.2, 85.5],
          180: [36.5, 41.0, 46.4, 52.6, 59.5, 67.2, 75.7, 85.0, 95.0],
          192: [41.0, 46.0, 52.0, 58.8, 66.5, 75.0, 84.3, 94.5, 105.5],
          204: [45.5, 51.0, 57.5, 65.0, 73.2, 82.3, 92.2, 103.0, 114.5],
          216: [49.0, 55.0, 62.0, 70.0, 78.8, 88.5, 99.0, 110.0, 122.0]
        },
        height: {
          0: [46.0, 47.5, 49.0, 50.5, 52.0, 53.5, 55.0, 56.5, 58.0],
          2: [53.0, 54.5, 56.5, 58.0, 59.5, 61.0, 62.5, 64.0, 65.5],
          4: [58.5, 60.0, 62.0, 63.5, 65.5, 67.0, 68.5, 70.5, 72.0],
          6: [62.5, 64.0, 66.0, 68.0, 69.5, 71.5, 73.5, 75.0, 77.0],
          9: [68.0, 69.5, 71.5, 73.5, 75.5, 77.5, 79.5, 81.5, 83.5],
          12: [71.0, 73.0, 75.0, 77.0, 79.0, 81.5, 83.5, 85.5, 87.5],
          18: [76.5, 79.0, 81.0, 83.5, 86.0, 88.0, 90.5, 92.5, 95.0],
          24: [81.0, 83.5, 86.0, 88.5, 91.0, 93.5, 96.0, 98.5, 101.0],
          36: [88.0, 91.0, 94.0, 97.0, 100.0, 103.0, 106.0, 109.0, 112.0],
          48: [94.5, 97.5, 101.0, 104.5, 108.0, 111.5, 115.0, 118.5, 122.0],
          60: [100.0, 103.5, 107.5, 111.5, 115.5, 119.5, 123.5, 127.5, 131.5],
          72: [105.0, 109.0, 113.5, 118.0, 122.5, 127.0, 131.5, 136.0, 140.0],
          84: [110.0, 114.5, 119.0, 124.0, 129.0, 134.0, 139.0, 144.0, 148.5],
          96: [115.0, 119.5, 124.5, 130.0, 135.0, 140.5, 146.0, 151.0, 156.0],
          108: [119.5, 124.5, 130.0, 135.5, 141.0, 146.5, 152.0, 157.5, 163.0],
          120: [124.0, 129.0, 134.5, 140.5, 146.5, 152.5, 158.0, 163.5, 169.0],
          132: [128.0, 133.5, 139.5, 146.0, 152.0, 158.0, 164.0, 169.5, 175.0],
          144: [132.5, 138.5, 145.0, 151.5, 158.0, 164.0, 170.0, 175.5, 181.0],
          156: [138.0, 144.5, 151.0, 158.0, 164.5, 170.5, 176.5, 182.0, 187.5],
          168: [145.0, 151.5, 158.0, 164.5, 171.0, 177.0, 182.5, 187.5, 192.5],
          180: [152.0, 158.0, 164.0, 170.0, 176.0, 181.5, 186.5, 191.0, 195.5],
          192: [157.0, 162.5, 168.0, 173.5, 179.0, 184.0, 188.5, 193.0, 197.0],
          204: [159.5, 165.0, 170.5, 175.5, 180.5, 185.5, 190.0, 194.0, 198.0],
          216: [161.0, 166.5, 172.0, 177.0, 182.0, 186.5, 191.0, 195.0, 199.0]
        },
        bmi: {
          0: [11.5, 12.0, 12.8, 13.4, 14.0, 14.7, 15.4, 16.2, 17.0],
          2: [13.8, 14.4, 15.2, 15.9, 16.7, 17.5, 18.3, 19.2, 20.0],
          4: [14.8, 15.4, 16.2, 16.9, 17.6, 18.4, 19.2, 20.0, 20.8],
          6: [15.2, 15.8, 16.5, 17.2, 17.9, 18.6, 19.4, 20.2, 21.0],
          9: [15.0, 15.6, 16.3, 17.0, 17.7, 18.4, 19.2, 20.0, 20.8],
          12: [14.8, 15.4, 16.0, 16.7, 17.4, 18.1, 18.9, 19.7, 20.5],
          15: [14.5, 15.0, 15.7, 16.4, 17.0, 17.7, 18.5, 19.3, 20.1],
          18: [14.2, 14.7, 15.4, 16.0, 16.7, 17.4, 18.1, 18.9, 19.7],
          21: [13.8, 14.4, 15.0, 15.7, 16.3, 17.0, 17.8, 18.6, 19.4],
          24: [12.5, 13.2, 14.0, 14.6, 15.3, 16.0, 16.8, 17.5, 18.3],
          36: [12.3, 12.9, 13.6, 14.2, 14.8, 15.5, 16.2, 17.0, 17.8],
          48: [12.2, 12.8, 13.4, 14.0, 14.6, 15.3, 16.0, 16.8, 17.6],
          60: [12.2, 12.7, 13.4, 14.0, 14.6, 15.3, 16.1, 16.9, 17.8],
          72: [12.3, 12.8, 13.5, 14.2, 14.9, 15.7, 16.6, 17.6, 18.6],
          84: [12.4, 13.0, 13.7, 14.5, 15.3, 16.2, 17.3, 18.5, 19.8],
          96: [12.6, 13.2, 14.0, 14.9, 15.8, 16.9, 18.1, 19.5, 21.2],
          108: [12.8, 13.5, 14.4, 15.3, 16.4, 17.6, 19.0, 20.7, 22.6],
          120: [13.1, 13.8, 14.8, 15.9, 17.0, 18.4, 20.0, 21.9, 24.2],
          132: [13.4, 14.2, 15.2, 16.4, 17.7, 19.2, 21.0, 23.2, 25.8],
          144: [13.8, 14.7, 15.8, 17.0, 18.5, 20.2, 22.2, 24.6, 27.5],
          156: [14.3, 15.2, 16.4, 17.8, 19.3, 21.2, 23.4, 26.0, 29.2],
          168: [14.8, 15.8, 17.0, 18.5, 20.2, 22.2, 24.6, 27.4, 30.8],
          180: [15.3, 16.4, 17.7, 19.3, 21.0, 23.2, 25.7, 28.7, 32.3],
          192: [15.8, 17.0, 18.4, 20.0, 21.8, 24.0, 26.6, 29.8, 33.5],
          204: [16.2, 17.5, 19.0, 20.6, 22.5, 24.8, 27.4, 30.6, 34.5],
          216: [16.5, 17.8, 19.4, 21.2, 23.1, 25.4, 28.1, 31.3, 35.2]
        }
      },
      female: {
        weight: {
          0: [2.1, 2.4, 2.7, 3.0, 3.3, 3.6, 3.9, 4.3, 4.6],
          2: [3.5, 3.9, 4.4, 4.9, 5.4, 5.9, 6.5, 7.0, 7.6],
          4: [4.6, 5.1, 5.7, 6.3, 6.9, 7.6, 8.3, 9.0, 9.7],
          6: [5.5, 6.0, 6.7, 7.4, 8.1, 8.9, 9.7, 10.5, 11.3],
          9: [6.4, 7.0, 7.8, 8.6, 9.4, 10.3, 11.2, 12.1, 13.0],
          12: [7.2, 7.9, 8.7, 9.6, 10.5, 11.4, 12.4, 13.4, 14.5],
          18: [8.2, 9.0, 10.0, 10.9, 12.0, 13.0, 14.2, 15.3, 16.5],
          24: [9.0, 9.9, 10.9, 12.0, 13.1, 14.3, 15.6, 16.9, 18.2],
          36: [10.6, 11.6, 12.8, 14.0, 15.3, 16.7, 18.2, 19.8, 21.4],
          48: [12.0, 13.2, 14.6, 16.0, 17.5, 19.2, 21.0, 22.9, 24.9],
          60: [13.4, 14.7, 16.3, 17.9, 19.7, 21.6, 23.7, 25.9, 28.3],
          72: [14.8, 16.3, 18.0, 19.9, 21.9, 24.1, 26.5, 29.2, 31.9],
          84: [16.2, 17.9, 19.8, 22.0, 24.3, 26.9, 29.7, 32.8, 36.0],
          96: [17.8, 19.7, 21.8, 24.3, 27.0, 29.9, 33.2, 36.8, 40.6],
          108: [19.5, 21.6, 24.0, 26.8, 29.9, 33.3, 37.1, 41.3, 45.7],
          120: [21.4, 23.8, 26.6, 29.7, 33.2, 37.1, 41.5, 46.3, 51.4],
          132: [23.6, 26.3, 29.4, 33.0, 37.0, 41.4, 46.4, 51.8, 57.6],
          144: [26.2, 29.3, 32.8, 36.9, 41.3, 46.3, 51.8, 57.8, 64.2],
          156: [29.3, 32.8, 36.7, 41.2, 46.1, 51.6, 57.6, 64.0, 71.0],
          168: [32.8, 36.6, 40.9, 45.8, 51.0, 56.8, 63.2, 70.0, 77.3],
          180: [36.5, 40.5, 45.0, 50.0, 55.5, 61.5, 68.0, 75.0, 82.5],
          192: [39.5, 43.8, 48.5, 53.8, 59.5, 65.5, 72.0, 79.0, 86.5],
          204: [41.5, 46.0, 51.0, 56.5, 62.3, 68.5, 75.0, 82.0, 89.5],
          216: [42.5, 47.2, 52.5, 58.0, 64.0, 70.5, 77.0, 84.0, 91.5]
        },
        height: {
          0: [45.0, 46.5, 48.0, 49.5, 51.0, 52.0, 53.5, 55.0, 56.5],
          2: [52.0, 53.5, 55.0, 56.5, 58.0, 59.5, 61.0, 62.5, 64.0],
          4: [57.5, 59.0, 60.5, 62.5, 64.0, 65.5, 67.5, 69.0, 70.5],
          6: [61.5, 63.0, 65.0, 66.5, 68.5, 70.0, 72.0, 73.5, 75.5],
          9: [66.0, 67.5, 69.5, 71.5, 73.5, 75.5, 77.5, 79.5, 81.5],
          12: [70.0, 72.0, 74.0, 76.0, 78.0, 80.0, 82.0, 84.0, 86.0],
          18: [76.0, 78.0, 80.5, 82.5, 85.0, 87.0, 89.0, 91.0, 93.5],
          24: [80.5, 83.0, 85.5, 88.0, 90.0, 92.5, 95.0, 97.0, 99.5],
          36: [87.0, 90.0, 93.0, 96.0, 99.0, 102.0, 105.0, 108.0, 111.0],
          48: [93.5, 96.5, 100.0, 103.5, 107.0, 110.5, 114.0, 117.5, 121.0],
          60: [99.0, 102.5, 106.5, 110.5, 114.5, 118.5, 122.5, 126.5, 130.5],
          72: [104.0, 108.0, 112.5, 117.0, 121.5, 126.0, 130.5, 135.0, 139.0],
          84: [109.0, 113.5, 118.5, 123.5, 128.5, 133.5, 138.0, 143.0, 147.5],
          96: [114.0, 119.0, 124.0, 129.5, 135.0, 140.0, 145.5, 150.5, 155.5],
          108: [119.0, 124.0, 129.5, 135.5, 141.0, 146.5, 152.0, 157.0, 162.0],
          120: [123.5, 129.0, 135.0, 141.0, 147.0, 152.5, 158.0, 163.0, 168.0],
          132: [128.5, 134.5, 140.5, 147.0, 153.0, 158.5, 164.0, 169.0, 174.0],
          144: [134.0, 140.5, 147.0, 153.0, 159.0, 164.5, 169.5, 174.5, 179.0],
          156: [140.0, 146.5, 152.5, 158.5, 164.0, 169.0, 173.5, 178.0, 182.0],
          168: [145.0, 151.0, 156.5, 162.0, 167.0, 171.5, 176.0, 180.0, 184.0],
          180: [148.0, 153.5, 158.5, 163.5, 168.5, 173.0, 177.0, 181.0, 185.0],
          192: [149.5, 155.0, 160.0, 165.0, 169.5, 174.0, 178.0, 182.0, 186.0],
          204: [150.0, 155.5, 160.5, 165.5, 170.0, 174.5, 178.5, 182.5, 186.5],
          216: [150.5, 156.0, 161.0, 166.0, 170.5, 175.0, 179.0, 183.0, 187.0]
        },
        bmi: {
          0: [11.0, 11.5, 12.3, 12.9, 13.5, 14.2, 14.9, 15.7, 16.5],
          2: [13.2, 13.8, 14.5, 15.2, 16.0, 16.7, 17.5, 18.3, 19.0],
          4: [14.2, 14.8, 15.5, 16.2, 17.0, 17.7, 18.5, 19.3, 20.0],
          6: [14.6, 15.2, 16.0, 16.7, 17.4, 18.1, 18.9, 19.7, 20.5],
          9: [14.4, 15.0, 15.7, 16.4, 17.1, 17.8, 18.6, 19.4, 20.2],
          12: [14.2, 14.8, 15.4, 16.1, 16.8, 17.5, 18.3, 19.1, 19.9],
          15: [14.0, 14.5, 15.2, 15.8, 16.5, 17.2, 18.0, 18.8, 19.6],
          18: [13.7, 14.2, 14.9, 15.5, 16.2, 16.9, 17.6, 18.4, 19.2],
          21: [13.4, 13.9, 14.5, 15.2, 15.8, 16.5, 17.3, 18.1, 18.9],
          24: [12.4, 13.0, 13.8, 14.5, 15.3, 16.1, 16.9, 17.7, 18.5],
          36: [12.1, 12.7, 13.4, 14.1, 14.8, 15.6, 16.4, 17.2, 18.1],
          48: [12.0, 12.5, 13.2, 13.9, 14.6, 15.4, 16.2, 17.0, 17.9],
          60: [12.0, 12.5, 13.2, 13.9, 14.6, 15.5, 16.3, 17.2, 18.2],
          72: [12.1, 12.6, 13.4, 14.1, 14.9, 15.8, 16.8, 17.9, 19.0],
          84: [12.2, 12.8, 13.6, 14.4, 15.3, 16.3, 17.4, 18.6, 20.0],
          96: [12.4, 13.0, 13.8, 14.7, 15.7, 16.8, 18.1, 19.5, 21.2],
          108: [12.6, 13.3, 14.1, 15.1, 16.2, 17.4, 18.8, 20.4, 22.3],
          120: [12.9, 13.6, 14.5, 15.6, 16.8, 18.1, 19.7, 21.5, 23.6],
          132: [13.2, 14.0, 15.0, 16.1, 17.4, 18.9, 20.6, 22.6, 25.0],
          144: [13.6, 14.5, 15.5, 16.8, 18.2, 19.8, 21.7, 23.9, 26.5],
          156: [14.1, 15.0, 16.2, 17.5, 19.0, 20.8, 22.8, 25.2, 28.0],
          168: [14.7, 15.7, 16.9, 18.3, 19.9, 21.8, 24.0, 26.5, 29.4],
          180: [15.3, 16.4, 17.7, 19.1, 20.8, 22.8, 25.0, 27.6, 30.6],
          192: [15.8, 16.9, 18.3, 19.8, 21.5, 23.5, 25.8, 28.5, 31.5],
          204: [16.2, 17.4, 18.8, 20.3, 22.1, 24.1, 26.4, 29.1, 32.2],
          216: [16.5, 17.7, 19.1, 20.7, 22.5, 24.5, 26.9, 29.6, 32.7]
        }
      }
    };

    function getInterpolatedData(data, ageMonths) {
      const ages = Object.keys(data).map(Number).sort((a, b) => a - b);
      if (ageMonths <= ages[0]) return data[ages[0]];
      if (ageMonths >= ages[ages.length - 1]) return data[ages[ages.length - 1]];
      let lowerAge = ages[0], upperAge = ages[ages.length - 1];
      for (let i = 0; i < ages.length - 1; i++) {
        if (ages[i] <= ageMonths && ages[i + 1] >= ageMonths) {
          lowerAge = ages[i];
          upperAge = ages[i + 1];
          break;
        }
      }
      const ratio = (ageMonths - lowerAge) / (upperAge - lowerAge);
      return data[lowerAge].map((v, i) => v + (data[upperAge][i] - v) * ratio);
    }

    function calculateExactPercentile(value, centileValues) {
      if (value <= centileValues[0]) return { exact: '<0.4', range: '<0.4th' };
      if (value >= centileValues[8]) return { exact: '>99.6', range: '>99.6th' };
      for (let i = 0; i < centileValues.length - 1; i++) {
        if (value >= centileValues[i] && value <= centileValues[i + 1]) {
          const ratio = (value - centileValues[i]) / (centileValues[i + 1] - centileValues[i]);
          const exactCentile = centiles[i] + ratio * (centiles[i + 1] - centiles[i]);
          const rangeLow = centiles[i];
          const rangeHigh = centiles[i + 1];
          const suffix = (n) => n === 1 ? 'st' : n === 2 ? 'nd' : n === 3 ? 'rd' : 'th';
          return {
            exact: exactCentile.toFixed(1),
            range: `${rangeLow}${suffix(rangeLow)}-${rangeHigh}${suffix(rangeHigh)}`
          };
        }
      }
      return { exact: '--', range: '--' };
    }

    function calculateGrowthPercentiles() {
      const ageValue = parseFloat(document.getElementById('ped-age').value);
      const ageUnit = document.getElementById('ped-age-unit').value;
      const weight = parseFloat(document.getElementById('ped-weight').value);
      const height = parseFloat(document.getElementById('ped-height').value);

      // Reset
      ['wt', 'ht', 'bmi'].forEach(t => {
        document.getElementById(`${t}-exact-centile`).textContent = '--';
        document.getElementById(`${t}-range-centile`).textContent = '--';
      });
      document.getElementById('ped-bmi-val').textContent = '--';
      document.getElementById('ped-ref-weight').textContent = '--';
      document.getElementById('growth-status').innerHTML = '';

      if (!ageValue) return;

      const ageMonths = ageUnit === 'years' ? ageValue * 12 : ageValue;
      const genderData = hkData[pedGender];

      // Reference weight P50
      const wtData = getInterpolatedData(genderData.weight, ageMonths);
      document.getElementById('ped-ref-weight').textContent = wtData[4].toFixed(1);

      // Weight percentile
      if (weight) {
        const result = calculateExactPercentile(weight, wtData);
        document.getElementById('wt-exact-centile').textContent = result.exact;
        document.getElementById('wt-range-centile').textContent = result.range;
      }

      // Height percentile
      if (height) {
        const htData = getInterpolatedData(genderData.height, ageMonths);
        const result = calculateExactPercentile(height, htData);
        document.getElementById('ht-exact-centile').textContent = result.exact;
        document.getElementById('ht-range-centile').textContent = result.range;
      }

      // BMI
      if (weight && height) {
        const bmi = weight / Math.pow(height / 100, 2);
        document.getElementById('ped-bmi-val').textContent = bmi.toFixed(1);

        if (genderData.bmi) {
          const bmiData = getInterpolatedData(genderData.bmi, ageMonths);
          const result = calculateExactPercentile(bmi, bmiData);
          document.getElementById('bmi-exact-centile').textContent = result.exact;
          document.getElementById('bmi-range-centile').textContent = result.range;

          // Status
          const exactVal = parseFloat(result.exact);
          let status = '';
          if (result.exact === '<0.4' || exactVal < 9) {
            status = '<span class="status-indicator warning"><i class="fas fa-exclamation-triangle"></i> Underweight</span>';
          } else if (result.exact === '>99.6' || exactVal > 91) {
            status = '<span class="status-indicator warning"><i class="fas fa-exclamation-triangle"></i> Overweight</span>';
          } else {
            status = '<span class="status-indicator normal"><i class="fas fa-check-circle"></i> Normal</span>';
          }
          document.getElementById('growth-status').innerHTML = status;
        }
      }

      calculatePedRealtime();
      updatePedReference();
    }

    // Reference data tables from clinical guidelines
    const energyRefData = {
      // Age in months: { male: kcal/kg/day, female: kcal/kg/day }
      months: {
        1: { m: '96-120', f: '96-120' },
        2: { m: '96-120', f: '96-120' },
        3: { m: '96', f: '96' },
        4: { m: '96', f: '96' },
        5: { m: '72-96', f: '72-96' },
        6: { m: '72-96', f: '72-96' },
        7: { m: '72', f: '72' },
        8: { m: '72', f: '72' },
        9: { m: '72', f: '72' },
        10: { m: '72', f: '72' },
        11: { m: '72', f: '72' },
        12: { m: '72', f: '72' }
      },
      // Age in years: { male: kcal/kg/day, female: kcal/kg/day }
      years: {
        1: { m: '80', f: '80' },
        2: { m: '82', f: '81' },
        3: { m: '82', f: '78' },
        4: { m: '85', f: '81' },
        5: { m: '80', f: '75' },
        6: { m: '74', f: '70' },
        7: { m: '71', f: '67' },
        8: { m: '67', f: '63' },
        9: { m: '63', f: '59' },
        10: { m: '64', f: '61' },
        11: { m: '62', f: '56' },
        12: { m: '59', f: '53' },
        13: { m: '56', f: '48' },
        14: { m: '54', f: '46' },
        15: { m: '51', f: '45' },
        16: { m: '49', f: '44' },
        17: { m: '48', f: '43' },
        18: { m: '48', f: '43' }
      }
    };

    const proteinRefData = {
      // Age in months: { male: g/kg/day, female: g/kg/day }
      months: {
        1: { m: '2.6', f: '2.6' },
        2: { m: '2.6', f: '2.6' },
        3: { m: '2.6', f: '2.6' },
        4: { m: '1.8', f: '1.8' },
        5: { m: '1.8', f: '1.8' },
        6: { m: '1.8', f: '1.8' },
        7: { m: '1.7', f: '1.7' },
        8: { m: '1.7', f: '1.6' },
        9: { m: '1.7', f: '1.6' },
        10: { m: '1.6', f: '1.6' },
        11: { m: '1.6', f: '1.6' },
        12: { m: '1.6', f: '1.6' }
      },
      years: {
        1: { m: '1.6', f: '1.6' },
        2: { m: '1.2', f: '1.2' },
        3: { m: '1.2', f: '1.2' },
        4: { m: '0.86', f: '0.86' },
        5: { m: '0.85', f: '0.85' },
        6: { m: '0.89', f: '0.89' },
        7: { m: '0.91', f: '0.91' },
        8: { m: '0.92', f: '0.92' },
        9: { m: '0.92', f: '0.92' },
        10: { m: '0.91', f: '0.91' },
        11: { m: '0.91', f: '0.90' },
        12: { m: '0.90', f: '0.89' },
        13: { m: '0.90', f: '0.88' },
        14: { m: '0.89', f: '0.87' },
        15: { m: '0.88', f: '0.85' },
        16: { m: '0.87', f: '0.84' },
        17: { m: '0.86', f: '0.83' },
        18: { m: '0.85', f: '0.82' }
      }
    };

    function getFluidRef(ageMonths, weight) {
      if (ageMonths < 1) return '20-30 mL/kg/d (1st day)';
      if (ageMonths < 6) return '150 mL/kg/d';
      if (ageMonths === 6) return '120-150 mL/kg/d';
      if (ageMonths <= 12) return '120 mL/kg/d';
      // Holliday-Segar for >1 year
      if (weight) {
        if (weight <= 10) return '100 mL/kg/d';
        if (weight <= 20) return '1000 + 50mL/kg >10kg';
        return '1500 + 20mL/kg >20kg';
      }
      return 'Holliday-Segar';
    }

    function updatePedReference() {
      const ageValue = parseFloat(document.getElementById('ped-age').value);
      const ageUnit = document.getElementById('ped-age-unit').value;
      const weight = parseFloat(document.getElementById('ped-weight').value);

      if (!ageValue) {
        document.getElementById('ref-energy-val').textContent = '--';
        document.getElementById('ref-protein-val').textContent = '--';
        document.getElementById('ref-fluid-val').textContent = '--';
        return;
      }

      const ageMonths = ageUnit === 'years' ? ageValue * 12 : ageValue;
      const ageYears = ageUnit === 'years' ? ageValue : ageValue / 12;
      const genderKey = pedGender === 'male' ? 'm' : 'f';

      let energy = '--', protein = '--';

      // Get energy reference
      if (ageMonths <= 12) {
        const monthKey = Math.max(1, Math.min(12, Math.round(ageMonths)));
        if (energyRefData.months[monthKey]) {
          energy = energyRefData.months[monthKey][genderKey] + ' kcal/kg';
        }
      } else {
        const yearKey = Math.max(1, Math.min(18, Math.round(ageYears)));
        if (energyRefData.years[yearKey]) {
          energy = energyRefData.years[yearKey][genderKey] + ' kcal/kg';
        }
      }

      // Get protein reference
      if (ageMonths <= 12) {
        const monthKey = Math.max(1, Math.min(12, Math.round(ageMonths)));
        if (proteinRefData.months[monthKey]) {
          protein = proteinRefData.months[monthKey][genderKey] + ' g/kg';
        }
      } else {
        const yearKey = Math.max(1, Math.min(18, Math.round(ageYears)));
        if (proteinRefData.years[yearKey]) {
          protein = proteinRefData.years[yearKey][genderKey] + ' g/kg';
        }
      }

      // Get fluid reference
      const fluid = getFluidRef(ageMonths, weight);

      document.getElementById('ref-energy-val').textContent = energy;
      document.getElementById('ref-protein-val').textContent = protein;
      document.getElementById('ref-fluid-val').textContent = fluid;
    }

    function calculatePedRealtime() {
      const weight = parseFloat(document.getElementById('ped-weight').value);
      const energyFactor = parseFloat(document.getElementById('ped-energy-factor').value);
      const proteinFactor = parseFloat(document.getElementById('ped-protein-factor').value);
      const fluidFactor = parseFloat(document.getElementById('ped-fluid-factor').value);

      document.getElementById('ped-energy-result').textContent = weight && energyFactor ? Math.round(weight * energyFactor) : '--';
      document.getElementById('ped-protein-result').textContent = weight && proteinFactor ? (weight * proteinFactor).toFixed(1) : '--';
      document.getElementById('ped-fluid-result').textContent = weight && fluidFactor ? Math.round(weight * fluidFactor) : '--';
    }

    function setPedGender(gender) {
      pedGender = gender;
      document.querySelectorAll('#tab-peds .segment-btn').forEach((btn, i) => {
        btn.classList.toggle('active', (gender === 'male' && i === 0) || (gender === 'female' && i === 1));
      });
      calculateGrowthPercentiles();
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
      document.getElementById(`tab-${tabName}`).classList.add('active');
      event.currentTarget.classList.add('active');
    }

    // Adult calculations
    function calculateBMIAndABW() {
      const weight = parseFloat(document.getElementById('actual-weight').value);
      const height = parseFloat(document.getElementById('actual-height').value);
      const idealBMI = parseFloat(document.getElementById('ideal-bmi').value) || 21.7;

      // Reset values
      document.getElementById('res-actual-bmi').textContent = '--';
      document.getElementById('res-ideal-bw').textContent = '--';
      document.getElementById('res-adjusted-bw').textContent = '--';

      // Need at least height to calculate Ideal BW
      if (!height) return;

      const heightM = height / 100;
      const idealBW = idealBMI * heightM * heightM;

      // Always show Ideal BW if height is provided
      document.getElementById('res-ideal-bw').textContent = idealBW.toFixed(1);

      // Calculate Actual BMI and Adjusted BW only if weight is provided
      if (weight) {
        const actualBMI = weight / (heightM * heightM);
        const adjustedBW = idealBW + (weight - idealBW) / 4;
        document.getElementById('res-actual-bmi').textContent = actualBMI.toFixed(1);
        document.getElementById('res-adjusted-bw').textContent = adjustedBW.toFixed(1);
      }
    }

    function calculateEstWeight() {
      const estBMI = parseFloat(document.getElementById('est-bmi').value);
      const estHeight = parseFloat(document.getElementById('est-height').value);
      if (!estBMI || !estHeight) {
        document.getElementById('res-est-weight').textContent = '--';
        return;
      }
      const estWeight = estBMI * Math.pow(estHeight / 100, 2);
      document.getElementById('res-est-weight').textContent = estWeight.toFixed(1);
    }

    let isConverting = false;
    function convertPoundsToKg() {
      if (isConverting) return; isConverting = true;
      const lb = parseFloat(document.getElementById('conv-pounds').value);
      document.getElementById('conv-kg').value = isNaN(lb) ? '' : (lb * 0.453592).toFixed(2);
      isConverting = false;
    }
    function convertKgToPounds() {
      if (isConverting) return; isConverting = true;
      const kg = parseFloat(document.getElementById('conv-kg').value);
      document.getElementById('conv-pounds').value = isNaN(kg) ? '' : (kg / 0.453592).toFixed(2);
      isConverting = false;
    }
    function convertFeetInchesToCm() {
      if (isConverting) return; isConverting = true;
      const ft = parseFloat(document.getElementById('conv-feet').value) || 0;
      const inch = parseFloat(document.getElementById('conv-inches').value) || 0;
      document.getElementById('conv-cm').value = (ft > 0 || inch > 0) ? ((ft * 12 + inch) * 2.54).toFixed(1) : '';
      isConverting = false;
    }
    function convertCmToFeetInches() {
      if (isConverting) return; isConverting = true;
      const cm = parseFloat(document.getElementById('conv-cm').value);
      if (!isNaN(cm) && cm > 0) {
        const totalIn = cm / 2.54;
        document.getElementById('conv-feet').value = Math.floor(totalIn / 12);
        document.getElementById('conv-inches').value = (totalIn % 12).toFixed(1);
      } else {
        document.getElementById('conv-feet').value = '';
        document.getElementById('conv-inches').value = '';
      }
      isConverting = false;
    }

    function calculateRequirementsRealtime() {
      const bw = parseFloat(document.getElementById('req-body-weight').value);
      const ef = parseFloat(document.getElementById('energy-factor').value);
      const pf = parseFloat(document.getElementById('protein-factor').value);
      document.getElementById('res-energy-req').textContent = bw && ef ? Math.round(bw * ef) : '--';
      document.getElementById('res-protein-req').textContent = bw && pf ? Math.round(bw * pf) : '--';
    }

    // Supplements - Hong Kong Market Only (values per 100ml)
    const supplementDatabase = [
      // Abbott Products (Hong Kong)
      { id: 1, brand: 'Abbott', name: 'Ensure Gold 金裝加營素', kcal: 100, protein: 4.0, carbs: 13.8, fat: 3.3 },
      { id: 2, brand: 'Abbott', name: 'Ensure Plus 加營素', kcal: 150, protein: 6.3, carbs: 20.0, fat: 5.0 },
      { id: 3, brand: 'Abbott', name: 'Ensure Plus Advance', kcal: 150, protein: 9.1, carbs: 14.5, fat: 5.8 },
      { id: 4, brand: 'Abbott', name: 'Ensure Nutrivigor', kcal: 150, protein: 6.3, carbs: 19.3, fat: 5.0 },
      { id: 5, brand: 'Abbott', name: 'Glucerna 怡保康', kcal: 100, protein: 4.2, carbs: 10.6, fat: 4.8 },
      { id: 6, brand: 'Abbott', name: 'Glucerna Tube Feed', kcal: 100, protein: 4.2, carbs: 9.6, fat: 5.4 },
      { id: 7, brand: 'Abbott', name: 'Nepro LP 腎加營', kcal: 180, protein: 4.1, carbs: 20.0, fat: 9.6 },
      { id: 8, brand: 'Abbott', name: 'Nepro HP 腎加營', kcal: 180, protein: 8.1, carbs: 16.1, fat: 9.6 },
      { id: 9, brand: 'Abbott', name: 'Jevity 健力體', kcal: 105, protein: 4.4, carbs: 12.7, fat: 3.9 },
      { id: 10, brand: 'Abbott', name: 'Osmolite 安素', kcal: 100, protein: 4.4, carbs: 13.3, fat: 3.5 },
      { id: 11, brand: 'Abbott', name: 'Pulmocare 肺加營', kcal: 150, protein: 6.3, carbs: 10.6, fat: 9.4 },
      { id: 12, brand: 'Abbott', name: 'ProSure 倍力康', kcal: 130, protein: 6.7, carbs: 14.5, fat: 5.0 },
      { id: 13, brand: 'Abbott', name: 'PediaSure 小安素', kcal: 100, protein: 3.0, carbs: 11.0, fat: 5.0 },
      { id: 14, brand: 'Abbott', name: 'Abound 速愈素', kcal: 78, protein: 7.0, carbs: 11.9, fat: 0.0 },
      // Nestlé Products (Hong Kong)
      { id: 15, brand: 'Nestlé', name: 'Isosource 1.2 HN 益源素', kcal: 120, protein: 5.4, carbs: 14.0, fat: 4.8 },
      { id: 16, brand: 'Nestlé', name: 'Nutren Optimum 佳膳', kcal: 100, protein: 4.0, carbs: 12.7, fat: 3.8 },
      { id: 17, brand: 'Nestlé', name: 'Nutren Diabetic Plus 佳膳適糖', kcal: 100, protein: 6.0, carbs: 9.5, fat: 4.3 },
      { id: 18, brand: 'Nestlé', name: 'Nutren Junior 兒童佳膳', kcal: 100, protein: 3.0, carbs: 11.2, fat: 4.8 },
      { id: 19, brand: 'Nestlé', name: 'Resource 力源素高蛋白', kcal: 125, protein: 9.4, carbs: 11.2, fat: 4.9 },
      { id: 20, brand: 'Nestlé', name: 'Impact Advanced', kcal: 100, protein: 7.8, carbs: 10.8, fat: 2.8 },
      // Nutricia Products (Hong Kong)
      { id: 21, brand: 'Nutricia', name: 'Fortisip 營保健', kcal: 150, protein: 6.0, carbs: 18.4, fat: 5.8 },
      { id: 22, brand: 'Nutricia', name: 'Fortisip Compact Protein 營保健', kcal: 245, protein: 14.4, carbs: 24.2, fat: 9.7 },
      { id: 23, brand: 'Nutricia', name: 'Fortimel 金裝能全素', kcal: 150, protein: 6.0, carbs: 18.4, fat: 5.8 },
      { id: 24, brand: 'Nutricia', name: 'Fortimel Protein 2kcal 能全素EX', kcal: 200, protein: 10.0, carbs: 22.5, fat: 8.0 },
      { id: 25, brand: 'Nutricia', name: 'Nutrison Standard', kcal: 100, protein: 4.0, carbs: 12.3, fat: 3.9 },
      { id: 26, brand: 'Nutricia', name: 'Nutrison Energy', kcal: 150, protein: 6.0, carbs: 18.4, fat: 5.8 },
      { id: 27, brand: 'Nutricia', name: 'Nutrison Protein Plus', kcal: 125, protein: 7.5, carbs: 14.5, fat: 4.9 },
      { id: 28, brand: 'Nutricia', name: 'Cubitan 康全力', kcal: 125, protein: 10.0, carbs: 14.0, fat: 3.5 },
      // Fresenius Kabi Products (Hong Kong) 倍力康
      { id: 29, brand: 'Fresenius Kabi', name: 'Fresubin Original 倍力康', kcal: 100, protein: 3.8, carbs: 13.0, fat: 3.3 },
      { id: 30, brand: 'Fresenius Kabi', name: 'Fresubin Energy 倍力康1.5千卡', kcal: 150, protein: 5.6, carbs: 18.8, fat: 5.8 },
      { id: 31, brand: 'Fresenius Kabi', name: 'Fresubin Energy Fibre 倍健纖', kcal: 150, protein: 5.6, carbs: 18.0, fat: 5.8 },
      { id: 32, brand: 'Fresenius Kabi', name: 'Fresubin 2kcal 倍力康2千卡', kcal: 200, protein: 10.0, carbs: 22.5, fat: 7.8 },
      { id: 33, brand: 'Fresenius Kabi', name: 'Fresubin 2kcal Fibre', kcal: 200, protein: 10.0, carbs: 22.5, fat: 7.8 },
      { id: 34, brand: 'Fresenius Kabi', name: 'Fresubin Pro 倍速定', kcal: 150, protein: 10.0, carbs: 14.0, fat: 5.8 },
      { id: 35, brand: 'Fresenius Kabi', name: 'Fresubin Jucy 果之保', kcal: 150, protein: 4.0, carbs: 33.5, fat: 0.0 },
      { id: 36, brand: 'Fresenius Kabi', name: 'Fresubin Hepa 肝力康', kcal: 130, protein: 4.0, carbs: 16.0, fat: 5.4 },
      { id: 37, brand: 'Fresenius Kabi', name: 'Fresubin Renal 腎力康', kcal: 200, protein: 7.0, carbs: 25.0, fat: 8.3 },
      { id: 38, brand: 'Fresenius Kabi', name: 'Supportan 加力康', kcal: 150, protein: 10.0, carbs: 12.3, fat: 6.7 },
      { id: 39, brand: 'Fresenius Kabi', name: 'Diben 倍糖適', kcal: 100, protein: 4.5, carbs: 9.4, fat: 5.0 }
    ];

    function populateSupplementDropdown() {
      const sel = document.getElementById('supplement-select');
      let currentBrand = '';
      let optionsHtml = '<option value="">-- Select Supplement --</option>';

      supplementDatabase.forEach(s => {
        if (s.brand !== currentBrand) {
          if (currentBrand !== '') optionsHtml += '</optgroup>';
          optionsHtml += `<optgroup label="${s.brand}">`;
          currentBrand = s.brand;
        }
        optionsHtml += `<option value="${s.id}">${s.name} (${s.kcal} kcal/100mL)</option>`;
      });
      optionsHtml += '</optgroup>';
      sel.innerHTML = optionsHtml;
    }

    function addSupplement() {
      const id = parseInt(document.getElementById('supplement-select').value);
      const amt = parseFloat(document.getElementById('supplement-amount').value);
      if (!id || !amt) return;
      const supp = supplementDatabase.find(s => s.id === id);
      addedSupplements.push({ ...supp, amount: amt });
      updateSupplementList();
      document.getElementById('supplement-select').value = '';
      document.getElementById('supplement-amount').value = '';
    }

    function updateSupplementList() {
      const list = document.getElementById('supplement-list');
      const summary = document.getElementById('nutrition-summary-card');
      if (addedSupplements.length === 0) {
        list.innerHTML = '<div class="empty-state"><i class="fas fa-flask"></i><p>No supplements added yet</p></div>';
        summary.style.display = 'none';
        return;
      }
      list.innerHTML = addedSupplements.map((s, i) => `
        <div class="supplement-item">
          <div class="supplement-info">
            <div class="supplement-name">${s.name}</div>
            <div class="supplement-amount">${s.amount} mL • ${Math.round(s.kcal * s.amount / 100)} kcal</div>
          </div>
          <div class="supplement-actions">
            <button class="action-btn edit" onclick="editSupplement(${i})"><i class="fas fa-pen"></i></button>
            <button class="action-btn delete" onclick="deleteSupplement(${i})"><i class="fas fa-trash"></i></button>
          </div>
        </div>
      `).join('');
      updateNutritionSummary();
      summary.style.display = 'block';
    }

    function updateNutritionSummary() {
      const totals = addedSupplements.reduce((a, s) => {
        const f = s.amount / 100;
        return { kcal: a.kcal + s.kcal * f, protein: a.protein + s.protein * f, carbs: a.carbs + s.carbs * f, fat: a.fat + s.fat * f };
      }, { kcal: 0, protein: 0, carbs: 0, fat: 0 });
      const vol = addedSupplements.reduce((a, s) => a + s.amount, 0);
      document.getElementById('macro-grid').innerHTML = `
        <div class="nutrient-item"><div class="nutrient-value">${Math.round(totals.kcal)}</div><div class="nutrient-name">kcal</div></div>
        <div class="nutrient-item"><div class="nutrient-value">${totals.protein.toFixed(1)}</div><div class="nutrient-name">Protein (g)</div></div>
        <div class="nutrient-item"><div class="nutrient-value">${totals.carbs.toFixed(1)}</div><div class="nutrient-name">Carbs (g)</div></div>
        <div class="nutrient-item"><div class="nutrient-value">${totals.fat.toFixed(1)}</div><div class="nutrient-name">Fat (g)</div></div>
        <div class="nutrient-item"><div class="nutrient-value">${vol}</div><div class="nutrient-name">Volume (mL)</div></div>
        <div class="nutrient-item"><div class="nutrient-value">${(totals.kcal / vol * 100).toFixed(0)}</div><div class="nutrient-name">kcal/100mL</div></div>
      `;
    }

    function editSupplement(i) { editingIndex = i; document.getElementById('edit-amount').value = addedSupplements[i].amount; document.getElementById('edit-modal').classList.add('active'); }
    function saveEdit() { const amt = parseFloat(document.getElementById('edit-amount').value); if (amt && editingIndex >= 0) { addedSupplements[editingIndex].amount = amt; updateSupplementList(); } closeModal(); }
    function deleteSupplement(i) { addedSupplements.splice(i, 1); updateSupplementList(); }
    function clearAllSupplements() { addedSupplements = []; updateSupplementList(); }
    function closeModal() { document.getElementById('edit-modal').classList.remove('active'); editingIndex = -1; }

    // Infant Formula Database (from Excel) - includes CHO (carbohydrates)
    const formulaDatabase = [
      { id: 1, category: 'Amino Acid Formula', name: 'Neocate Junior', nameCN: '紐康特 1+', kcal: 100, protein: 3.1, fat: 5.0, carbs: 10.7, scoopWeight: 7.3, dilution: '1:30ml' },
      { id: 2, category: 'Amino Acid Formula', name: 'Neocate LCP', nameCN: '紐康特™ Neocate LCP 無敏配方', kcal: 67, protein: 1.8, fat: 3.5, carbs: 7.1, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 3, category: 'Amino Acid Formula', name: 'Neocate Syneo HMO (0-12 months)', nameCN: '紐康特星諾100%氨基酸無敏配方(0-12個月)', kcal: 68, protein: 1.9, fat: 3.4, carbs: 7.2, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 4, category: 'Extensively Hydrolyzed Formula', name: 'Alfare', nameCN: '藹兒舒® - 低敏配方嬰兒奶粉', kcal: 68, protein: 2.0, fat: 3.4, carbs: 7.3, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 5, category: 'Extensively Hydrolyzed Formula', name: 'Neocate Pepti Syneo HMO', nameCN: '太益啟舒敏(0-12個月配方)', kcal: 65, protein: 1.6, fat: 3.4, carbs: 7.1, scoopWeight: 4.6, dilution: '1:30ml' },
      { id: 6, category: 'Extensively Hydrolyzed Formula', name: 'Neocate Pepti Syneo Jr HMO (1-10yo)', nameCN: '紐康特® 太益加® 深度水解蛋白配方', kcal: 67, protein: 1.6, fat: 3.2, carbs: 7.8, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 7, category: 'Extensively Hydrolyzed Formula', name: 'Nutramigen Hypoallergenic LGG 1', nameCN: '安敏健LIPIL深度水解蛋白低敏配方', kcal: 68, protein: 1.91, fat: 3.4, carbs: 7.5, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 8, category: 'Extensively Hydrolyzed Formula', name: 'Nutricia Pepti-Junior (0-12 months)', nameCN: '金裝紐太特', kcal: 66, protein: 1.8, fat: 3.5, carbs: 6.8, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 9, category: 'Extensively Hydrolyzed Formula', name: 'Peptamen Junior (1-10 years old)', nameCN: '兒童佳易得', kcal: 102, protein: 3.0, fat: 3.9, carbs: 13.8, scoopWeight: 7.9, dilution: '1:30ml' },
      { id: 10, category: 'High Energy Formula (<1 year)', name: 'Enfamil A+ Step-Up Care (Powder)', nameCN: '安嬰兒 A+ 早產/低體重嬰兒增長配方', kcal: 75, protein: 2.0, fat: 3.9, carbs: 7.7, scoopWeight: 4.97, dilution: '1:30ml' },
      { id: 11, category: 'High Energy Formula (<1 year)', name: 'Infatrini', nameCN: '', kcal: 100, protein: 2.6, fat: 5.4, carbs: 10.1, scoopWeight: null, dilution: 'RTF' },
      { id: 12, category: 'High Energy Formula (>1 year)', name: 'Fortini 1+', nameCN: '紐荃星壹加', kcal: 100, protein: 2.6, fat: 4.6, carbs: 11.7, scoopWeight: 5.3, dilution: '1:20ml' },
      { id: 13, category: 'High Energy Formula (>1 year)', name: 'Nutren Junior (Powder)', nameCN: '兒童佳膳', kcal: 102, protein: 3.04, fat: 4.04, carbs: 13.36, scoopWeight: 7.86, dilution: '7:210ml=250ml' },
      { id: 14, category: 'High Energy Formula (>1 year)', name: 'Nutren Junior (RTF)', nameCN: '兒童佳膳', kcal: 100, protein: 3, fat: 4.8, carbs: 11.2, scoopWeight: null, dilution: 'RTF' },
      { id: 15, category: 'High Energy Formula (>1 year)', name: 'PediaSure Chocolate 3+/Vanilla 3+', nameCN: '保兒加營素 3＋朱古力/雲呢嗱', kcal: 100, protein: 3, fat: 3.91, carbs: 12.89, scoopWeight: null, dilution: '5:190ml=225ml' },
      { id: 16, category: 'High Energy Formula (>1 year)', name: 'PediaSure Vanilla 1+', nameCN: '保兒加營素 1＋雲呢嗱', kcal: 100, protein: 3, fat: 3.91, carbs: 13.11, scoopWeight: null, dilution: '5:190ml=225ml' },
      { id: 17, category: 'Soy/Lactose-free Formula', name: 'Enfamil A+ Lactofree', nameCN: '安嬰兒 A+ 無乳糖', kcal: 68, protein: 1.42, fat: 3.7, carbs: 7.2, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 18, category: 'Soy/Lactose-free Formula', name: 'Frisolac Gold Lactose Free', nameCN: '美素力金裝無乳糖', kcal: 67, protein: 1.3, fat: 3.5, carbs: 7.4, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 19, category: 'Soy/Lactose-free Formula', name: 'Nan EXPERTPRO AL 110', nameCN: '能恩無乳糖', kcal: 67, protein: 1.4, fat: 3.4, carbs: 7.8, scoopWeight: 4.44, dilution: '1:30ml' },
      { id: 20, category: 'Soy/Lactose-free Formula', name: 'Similac Isomil', nameCN: '愛心美豆奶', kcal: 68, protein: 1.71, fat: 3.67, carbs: 7.22, scoopWeight: null, dilution: '1:60ml' },
      { id: 21, category: 'Stage 1 Formula (0-6m)', name: 'Aptamil ESSENSIS HMO 1', nameCN: '愛他美HMO 1號', kcal: 69, protein: 1.3, fat: 3.4, carbs: 8.2, scoopWeight: 4.6, dilution: '1:30ml' },
      { id: 22, category: 'Stage 1 Formula (0-6m)', name: 'Aptamil ESSENSIS NEO 1', nameCN: '愛他美至熠1號', kcal: 68, protein: 1.3, fat: 3.5, carbs: 7.9, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 23, category: 'Stage 1 Formula (0-6m)', name: 'Aptamil ESSENSIS PHP 1', nameCN: '愛他美親熠1號', kcal: 69, protein: 1.5, fat: 3.4, carbs: 8.0, scoopWeight: 4.6, dilution: '1:30ml' },
      { id: 24, category: 'Stage 1 Formula (0-6m)', name: 'Aptamil Profutura Platinum 1', nameCN: '愛他美白金版1號', kcal: 67, protein: 1.3, fat: 3.4, carbs: 7.8, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 25, category: 'Stage 1 Formula (0-6m)', name: 'Cow & Gate Happy Tummy 1', nameCN: '牛欄牌1號', kcal: 68, protein: 1.4, fat: 3.5, carbs: 7.7, scoopWeight: 7.4, dilution: '1:50ml' },
      { id: 26, category: 'Stage 1 Formula (0-6m)', name: 'Enfa A+ Neuro Pro 1', nameCN: 'A+ 智睿1號', kcal: 66, protein: 1.39, fat: 3.4, carbs: 7.7, scoopWeight: 4.4, dilution: '1:30ml' },
      { id: 27, category: 'Stage 1 Formula (0-6m)', name: 'Enfinitas 1', nameCN: '藍臻1號', kcal: 68, protein: 1.43, fat: 3.6, carbs: 7.6, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 28, category: 'Stage 1 Formula (0-6m)', name: 'FRISO PRESTIGE 1', nameCN: '皇家美素力1號', kcal: 67, protein: 1.4, fat: 3.5, carbs: 7.3, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 29, category: 'Stage 1 Formula (0-6m)', name: 'FRISO PRESTIGE BIO 1', nameCN: '皇家美素力有機1號', kcal: 66, protein: 1.5, fat: 3.5, carbs: 7.2, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 30, category: 'Stage 1 Formula (0-6m)', name: 'FRISOLAC Gold 1', nameCN: '美素力金裝1號', kcal: 66, protein: 1.4, fat: 3.5, carbs: 7.3, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 31, category: 'Stage 1 Formula (0-6m)', name: 'FRISOLAC SIGNATURE 1', nameCN: '', kcal: 67, protein: 1.4, fat: 3.4, carbs: 7.7, scoopWeight: 4.4, dilution: '1:30ml' },
      { id: 32, category: 'Stage 1 Formula (0-6m)', name: 'Gentle Care Pro 1', nameCN: '親舒Pro1號', kcal: 67, protein: 1.54, fat: 3.7, carbs: 7.1, scoopWeight: 4.4, dilution: '1:30ml' },
      { id: 33, category: 'Stage 1 Formula (0-6m)', name: 'HiPP Organic HMP 1', nameCN: '喜寶HMP有機1號', kcal: 66, protein: 1.3, fat: 3.6, carbs: 7.3, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 34, category: 'Stage 1 Formula (0-6m)', name: 'ILLUMA Atwo 1', nameCN: '', kcal: 68, protein: 1.3, fat: 3.6, carbs: 7.4, scoopWeight: 8.9, dilution: '1:60ml' },
      { id: 35, category: 'Stage 1 Formula (0-6m)', name: 'ILLUMA LUXA 1', nameCN: '', kcal: 68, protein: 1.3, fat: 3.6, carbs: 7.4, scoopWeight: 8.9, dilution: '1:60ml' },
      { id: 36, category: 'Stage 1 Formula (0-6m)', name: 'ILLUMA Organic 1', nameCN: '親和人體有機1號', kcal: 67, protein: 1.5, fat: 3.6, carbs: 7.3, scoopWeight: 8.7, dilution: '1:60ml' },
      { id: 37, category: 'Stage 1 Formula (0-6m)', name: 'ILLUMA XTRACARE 1', nameCN: '親和人體低敏1號', kcal: 67, protein: 1.3, fat: 3.4, carbs: 7.8, scoopWeight: 4.4, dilution: '1:30ml' },
      { id: 38, category: 'Stage 1 Formula (0-6m)', name: 'Kabrita Infant Formula 1', nameCN: '佳貝艾特初生嬰兒羊奶粉1號', kcal: 67.6, protein: 1.4, fat: 3.5, carbs: 7.6, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 39, category: 'Stage 1 Formula (0-6m)', name: 'Karihome HMO Infant Goat Milk 1', nameCN: '卡洛塔妮星護嬰兒羊奶粉1號', kcal: 66, protein: 1.3, fat: 3.5, carbs: 7.2, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 40, category: 'Stage 1 Formula (0-6m)', name: 'Kendamil First Infant Milk 1', nameCN: '康多蜜兒1號', kcal: 67, protein: 1.3, fat: 3.6, carbs: 7.2, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 41, category: 'Stage 1 Formula (0-6m)', name: 'Kendamil Organic First Infant milk 1', nameCN: '康多蜜兒有機1號', kcal: 66, protein: 1.4, fat: 3.5, carbs: 7.0, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 42, category: 'Stage 1 Formula (0-6m)', name: 'NAN INFINIPRO 1', nameCN: '能恩全護1號', kcal: 67, protein: 1.27, fat: 3.47, carbs: 7.7, scoopWeight: 4.37, dilution: '1:30ml' },
      { id: 43, category: 'Stage 1 Formula (0-6m)', name: 'NAN PRO 1', nameCN: '能恩啟護1號', kcal: 67, protein: 1.27, fat: 3.42, carbs: 7.8, scoopWeight: 4.37, dilution: '1:30ml' },
      { id: 44, category: 'Stage 1 Formula (0-6m)', name: 'Nan Expertpro Comfort+', nameCN: '能恩腸道舒護', kcal: 67, protein: 1.3, fat: 3.5, carbs: 7.6, scoopWeight: 4.37, dilution: '1:30ml' },
      { id: 45, category: 'Stage 1 Formula (0-6m)', name: 'S-26 GOLD PROMIL 1', nameCN: '', kcal: 67, protein: 1.3, fat: 3.6, carbs: 7.4, scoopWeight: 8.6, dilution: '1:60ml' },
      { id: 46, category: 'Stage 1 Formula (0-6m)', name: 'S-26 ULTIMA 1', nameCN: '', kcal: 68, protein: 1.3, fat: 3.6, carbs: 7.5, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 47, category: 'Stage 1 Formula (0-6m)', name: 'SMART BABY 1', nameCN: '思敏兒1號', kcal: 67, protein: 1.4, fat: 3.6, carbs: 7.3, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 48, category: 'Stage 1 Formula (0-6m)', name: 'a2 Genesis HMO 1', nameCN: 'a2 紫曜HMO 1號', kcal: 69, protein: 1.5, fat: 3.4, carbs: 8.1, scoopWeight: 7.5, dilution: '1:50ml' },
      { id: 49, category: 'Stage 1 Formula (0-6m)', name: 'a2 Platinum Premium 1', nameCN: 'a2白金優質1號', kcal: 67.62, protein: 1.5, fat: 3.5, carbs: 7.6, scoopWeight: 7.5, dilution: '1:50ml' },
      { id: 50, category: 'Stage 2 Formula (6-12m)', name: 'Aptamil ESSENSIS HMO 2', nameCN: '愛他美HMO 2號', kcal: 67, protein: 1.4, fat: 3.2, carbs: 8.1, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 51, category: 'Stage 2 Formula (6-12m)', name: 'Aptamil ESSENSIS NEO 2', nameCN: '愛他美至熠2號', kcal: 66, protein: 1.4, fat: 3.2, carbs: 8.0, scoopWeight: 4.7, dilution: '1:30ml' },
      { id: 52, category: 'Stage 2 Formula (6-12m)', name: 'Aptamil ESSENSIS PHP 2', nameCN: '愛他美親熠2號', kcal: 67, protein: 1.6, fat: 3.0, carbs: 8.4, scoopWeight: 4.9, dilution: '1:30ml' },
      { id: 53, category: 'Stage 2 Formula (6-12m)', name: 'Aptamil Profutura Platinum 2', nameCN: '愛他美白金版2號', kcal: 67, protein: 1.3, fat: 3.4, carbs: 7.7, scoopWeight: 4.7, dilution: '1:30ml' },
      { id: 54, category: 'Stage 2 Formula (6-12m)', name: 'Cow & Gate Happy Tummy 2', nameCN: '牛欄牌2號', kcal: 67, protein: 1.4, fat: 3.5, carbs: 7.4, scoopWeight: 7.7, dilution: '1:50ml' },
      { id: 55, category: 'Stage 2 Formula (6-12m)', name: 'Enfa A+ Neuro Pro 2', nameCN: 'A+ 智睿2號', kcal: 68, protein: 2.2, fat: 3.0, carbs: 7.8, scoopWeight: 4.82, dilution: '1:30ml' },
      { id: 56, category: 'Stage 2 Formula (6-12m)', name: 'Enfinitas 2', nameCN: '藍臻2號', kcal: 68, protein: 2.2, fat: 2.8, carbs: 8.2, scoopWeight: 5.0, dilution: '1:30ml' },
      { id: 57, category: 'Stage 2 Formula (6-12m)', name: 'FRISO PRESTIGE 2', nameCN: '皇家美素佳兒2號', kcal: 68, protein: 2.2, fat: 3.1, carbs: 7.7, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 58, category: 'Stage 2 Formula (6-12m)', name: 'FRISO PRESTIGE BIO 2', nameCN: '美素佳兒有機2號', kcal: 67, protein: 2.2, fat: 3.0, carbs: 7.9, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 59, category: 'Stage 2 Formula (6-12m)', name: 'FRISOLAC Gold 2', nameCN: '美素佳兒金裝2號', kcal: 70, protein: 2.3, fat: 3.2, carbs: 8.0, scoopWeight: 5.0, dilution: '1:30ml' },
      { id: 60, category: 'Stage 2 Formula (6-12m)', name: 'FRISOLAC SIGNATURE 2', nameCN: '', kcal: 68, protein: 1.5, fat: 3.4, carbs: 7.9, scoopWeight: 4.7, dilution: '1:30ml' },
      { id: 61, category: 'Stage 2 Formula (6-12m)', name: 'Gentle Care Pro 2', nameCN: '親舒Pro2號', kcal: 67, protein: 1.54, fat: 3.7, carbs: 6.9, scoopWeight: 4.4, dilution: '1:30ml' },
      { id: 62, category: 'Stage 2 Formula (6-12m)', name: 'HiPP Organic HMP 2', nameCN: '喜寶HMP有機2號', kcal: 68, protein: 1.3, fat: 3.7, carbs: 7.6, scoopWeight: 4.5, dilution: '1:30ml' },
      { id: 63, category: 'Stage 2 Formula (6-12m)', name: 'ILLUMA Atwo 2', nameCN: '', kcal: 67, protein: 2.2, fat: 3.2, carbs: 7.2, scoopWeight: 7.3, dilution: '1:46.66ml' },
      { id: 64, category: 'Stage 2 Formula (6-12m)', name: 'ILLUMA LUXA 2', nameCN: '', kcal: 67, protein: 2.2, fat: 3.2, carbs: 7.2, scoopWeight: 7.3, dilution: '1:46.66ml' },
      { id: 65, category: 'Stage 2 Formula (6-12m)', name: 'ILLUMA Organic 2', nameCN: '親和人體有機2號', kcal: 66, protein: 2.1, fat: 3.0, carbs: 7.7, scoopWeight: 7.0, dilution: '1:46.66ml' },
      { id: 66, category: 'Stage 2 Formula (6-12m)', name: 'Kabrita Infant Formula 2', nameCN: '佳貝艾特羊奶粉2號', kcal: 65.7, protein: 2.1, fat: 2.9, carbs: 7.6, scoopWeight: 4.7, dilution: '1:30ml' },
      { id: 67, category: 'Stage 2 Formula (6-12m)', name: 'Kendamil Follow-On Milk 2', nameCN: '康多蜜兒2號', kcal: 68, protein: 1.4, fat: 3.4, carbs: 7.9, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 68, category: 'Stage 2 Formula (6-12m)', name: 'Kendamil Organic Follow-On milk 2', nameCN: '康多蜜兒有機2號', kcal: 68, protein: 1.5, fat: 3.2, carbs: 8.0, scoopWeight: 4.3, dilution: '1:30ml' },
      { id: 69, category: 'Stage 2 Formula (6-12m)', name: 'NAN INFINIPRO 2', nameCN: '能恩全護2號', kcal: 67, protein: 2.0, fat: 3.2, carbs: 7.5, scoopWeight: 4.56, dilution: '1:30ml' },
      { id: 70, category: 'Stage 2 Formula (6-12m)', name: 'NAN PRO 2', nameCN: '能恩啟護2號', kcal: 67, protein: 2.01, fat: 3.08, carbs: 7.8, scoopWeight: 4.56, dilution: '1:30ml' },
      { id: 71, category: 'Stage 2 Formula (6-12m)', name: 'S-26 GOLD PROMIL 2', nameCN: '', kcal: 66, protein: 2.1, fat: 3.0, carbs: 7.6, scoopWeight: 7.05, dilution: '1:45ml' },
      { id: 72, category: 'Stage 2 Formula (6-12m)', name: 'S-26 ULTIMA 2', nameCN: '', kcal: 67, protein: 2.1, fat: 3.6, carbs: 6.5, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 73, category: 'Stage 2 Formula (6-12m)', name: 'SMART BABY 2', nameCN: '思敏兒2號', kcal: 70, protein: 2.3, fat: 2.9, carbs: 8.7, scoopWeight: 5.0, dilution: '1:30ml' },
      { id: 74, category: 'Stage 2 Formula (6-12m)', name: 'a2 Genesis HMO 2', nameCN: 'a2 紫曜HMO 2號', kcal: 66, protein: 1.5, fat: 3.5, carbs: 7.1, scoopWeight: 7.6, dilution: '1:50ml' },
      { id: 75, category: 'Stage 2 Formula (6-12m)', name: 'a2 Platinum Premium 2', nameCN: 'a2白金優質2號', kcal: 72.38, protein: 1.9, fat: 3.5, carbs: 8.4, scoopWeight: 8.5, dilution: '1:50ml' },
      { id: 76, category: 'Stage 3 Formula (1-3y)', name: 'A2 Genesis HMO 3', nameCN: 'a2 紫曜HMO 3號', kcal: 66, protein: 1.9, fat: 2.9, carbs: 8.2, scoopWeight: 8.0, dilution: '1:50ml' },
      { id: 77, category: 'Stage 3 Formula (1-3y)', name: 'A2 Platinum 3', nameCN: 'a2白金優質3號', kcal: 69, protein: 2.7, fat: 3.0, carbs: 7.8, scoopWeight: 8.5, dilution: '1:50ml' },
      { id: 78, category: 'Stage 3 Formula (1-3y)', name: 'Aptamil Essensis HMO 3', nameCN: '愛他美HMO 3號', kcal: 64, protein: 1.3, fat: 2.6, carbs: 8.8, scoopWeight: 5.0, dilution: '1:30ml' },
      { id: 79, category: 'Stage 3 Formula (1-3y)', name: 'Aptamil Essensis NEO 3', nameCN: '愛他美至熠 3號', kcal: 69, protein: 1.4, fat: 3.3, carbs: 8.4, scoopWeight: 4.9, dilution: '1:30ml' },
      { id: 80, category: 'Stage 3 Formula (1-3y)', name: 'Aptamil Essensis PHP 3', nameCN: '愛他美親熠 3號', kcal: 64, protein: 1.5, fat: 2.9, carbs: 8.0, scoopWeight: 4.7, dilution: '1:30ml' },
      { id: 81, category: 'Stage 3 Formula (1-3y)', name: 'Aptamil Profutura Platinum 3', nameCN: '愛他美白金版 3號', kcal: 69, protein: 1.7, fat: 3.4, carbs: 7.9, scoopWeight: 5.1, dilution: '1:30ml' },
      { id: 82, category: 'Stage 3 Formula (1-3y)', name: 'Cow & Gate Happy Tummy 3', nameCN: '牛欄牌3號', kcal: 70, protein: 1.8, fat: 3.6, carbs: 7.5, scoopWeight: 8.5, dilution: '1:50ml' },
      { id: 83, category: 'Stage 3 Formula (1-3y)', name: 'Enfagrow A+ NeuroPro S3', nameCN: 'A+ 智睿3號', kcal: 78, protein: 2.4, fat: 2.9, carbs: 10.23, scoopWeight: 10.0, dilution: '1:50ml' },
      { id: 84, category: 'Stage 3 Formula (1-3y)', name: 'Enfinitas S3', nameCN: '藍臻3號', kcal: 81, protein: 2.6, fat: 3.0, carbs: 10.6, scoopWeight: 10.0, dilution: '1:48ml' },
      { id: 85, category: 'Stage 3 Formula (1-3y)', name: 'Friso Gold 3', nameCN: '荷蘭美素佳兒金裝3號', kcal: 68, protein: 2.3, fat: 2.8, carbs: 8.2, scoopWeight: 6.0, dilution: '1:36ml' },
      { id: 86, category: 'Stage 3 Formula (1-3y)', name: 'Friso Prestige 3', nameCN: '皇家美素佳兒3號成長配方奶粉', kcal: 67, protein: 2.2, fat: 3.1, carbs: 7.6, scoopWeight: 7.1, dilution: '1:45ml' },
      { id: 87, category: 'Stage 3 Formula (1-3y)', name: 'Friso Prestige Bio 3', nameCN: '皇家美素佳兒有機3號', kcal: 69, protein: 2.2, fat: 3.0, carbs: 8.1, scoopWeight: 4.9, dilution: '1:36ml' },
      { id: 88, category: 'Stage 3 Formula (1-3y)', name: 'Friso Signature Pro-IG 3', nameCN: '', kcal: 68, protein: 1.7, fat: 3.0, carbs: 8.4, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 89, category: 'Stage 3 Formula (1-3y)', name: 'Gentle Care Pro Stage 3', nameCN: '親舒Pro 3號', kcal: 75, protein: 1.8, fat: 4.1, carbs: 7.7, scoopWeight: 10.0, dilution: '1:60ml' },
      { id: 90, category: 'Stage 3 Formula (1-3y)', name: 'HiPP Organic Combiotic HMP 3', nameCN: '喜寶有機雙益HMP幼兒配方奶粉3號', kcal: 60, protein: 1.4, fat: 3.3, carbs: 6.4, scoopWeight: 3.97, dilution: '1:30ml' },
      { id: 91, category: 'Stage 3 Formula (1-3y)', name: 'Illuma Atwo 3', nameCN: '', kcal: 67, protein: 2.1, fat: 3.0, carbs: 7.7, scoopWeight: 7.3, dilution: '3:130ml' },
      { id: 92, category: 'Stage 3 Formula (1-3y)', name: 'Illuma Luxa 3', nameCN: '', kcal: 67, protein: 2.2, fat: 3.0, carbs: 7.7, scoopWeight: 7.3, dilution: '3:130ml' },
      { id: 93, category: 'Stage 3 Formula (1-3y)', name: 'Illuma Organic 3', nameCN: '親和人體有機3號', kcal: 74, protein: 2.4, fat: 2.5, carbs: 10.5, scoopWeight: 8.5, dilution: '3:130ml' },
      { id: 94, category: 'Stage 3 Formula (1-3y)', name: 'Illuma XTRACARE HA 3', nameCN: '親和人體低敏3號', kcal: 67, protein: 1.3, fat: 3.1, carbs: 8.5, scoopWeight: 4.6, dilution: '1:30ml' },
      { id: 95, category: 'Stage 3 Formula (1-3y)', name: 'Kabrita Goat milk 3', nameCN: '佳貝艾特羊奶粉3號', kcal: 67, protein: 2.2, fat: 2.5, carbs: 8.6, scoopWeight: 4.97, dilution: '1:30ml' },
      { id: 96, category: 'Stage 3 Formula (1-3y)', name: 'Karihome 3', nameCN: '卡洛塔妮幼兒羊奶粉3號', kcal: 71, protein: 2.6, fat: 3.7, carbs: 7.1, scoopWeight: 4.9, dilution: '1:30ml' },
      { id: 97, category: 'Stage 3 Formula (1-3y)', name: 'Karihome HMO Multishield Protect 3', nameCN: '卡洛塔妮星護羊奶粉3號', kcal: 70, protein: 2.0, fat: 3.5, carbs: 7.6, scoopWeight: 4.8, dilution: '1:30ml' },
      { id: 98, category: 'Stage 3 Formula (1-3y)', name: 'Nan Infinipro 6HMO 3', nameCN: '能恩全護3號', kcal: 67, protein: 2.0, fat: 3.09, carbs: 7.8, scoopWeight: 4.56, dilution: '1:30ml' },
      { id: 99, category: 'Stage 3 Formula (1-3y)', name: 'Nan Pro 2HMO 3', nameCN: '能恩啟護3號', kcal: 67, protein: 1.27, fat: 3.1, carbs: 8.5, scoopWeight: 4.56, dilution: '1:30ml' },
      { id: 100, category: 'Stage 3 Formula (1-3y)', name: 'S-26 Gold Progress 3', nameCN: '', kcal: 75, protein: 2.4, fat: 2.5, carbs: 10.6, scoopWeight: 7.0, dilution: '6:210ml' },
      { id: 101, category: 'Stage 3 Formula (1-3y)', name: 'S-26 Ultima Stage 3', nameCN: '', kcal: 67, protein: 2.1, fat: 3.6, carbs: 6.5, scoopWeight: 4.3, dilution: '8:210ml' },
      { id: 102, category: 'Stage 3 Formula (1-3y)', name: 'Similac 5HMO 3', nameCN: '心美力HMO3號', kcal: 73, protein: 2.45, fat: 3.34, carbs: 8.36, scoopWeight: 10.4, dilution: '1:60ml' },
      { id: 103, category: 'Stage 3 Formula (1-3y)', name: 'Smart Kid 3', nameCN: '思敏傑3幼兒助長奶粉', kcal: 78, protein: 2.7, fat: 2.9, carbs: 10.0, scoopWeight: 5.5, dilution: '1:30ml' },
      { id: 104, category: 'Thickened Formula', name: 'Frisolac Gold Comfort', nameCN: '美素力金裝倍護', kcal: 66, protein: 1.4, fat: 3.4, carbs: 7.5, scoopWeight: 4.3, dilution: '1:30ml' }
    ];

    function populateFormulaDropdown() {
      let currentCategory = '';
      let optionsHtml = '<option value="">-- Select Formula --</option>';

      formulaDatabase.forEach(f => {
        if (f.category !== currentCategory) {
          if (currentCategory !== '') optionsHtml += '</optgroup>';
          optionsHtml += `<optgroup label="${f.category}">`;
          currentCategory = f.category;
        }
        const displayName = f.nameCN ? `${f.name} (${f.nameCN})` : f.name;
        optionsHtml += `<option value="${f.id}">${displayName}</option>`;
      });
      optionsHtml += '</optgroup>';

      // Populate all formula dropdowns
      document.getElementById('formula-select-1').innerHTML = optionsHtml;
      document.getElementById('formula-select-2').innerHTML = optionsHtml;
      document.getElementById('strength-formula-select').innerHTML = optionsHtml;
      document.getElementById('reverse-formula-select').innerHTML = optionsHtml;
    }

    function getFormulaById(id) {
      return formulaDatabase.find(f => f.id === id);
    }

    function getSelectedFormula(n) {
      const id = parseInt(document.getElementById(`formula-select-${n}`).value);
      return formulaDatabase.find(f => f.id === id);
    }

    function updateFormulaInfo(n) {
      const formula = getSelectedFormula(n);
      const infoDiv = document.getElementById(`formula-info-${n}`);

      if (!formula) {
        infoDiv.style.display = 'none';
        document.getElementById(`formula-kcal-result-${n}`).textContent = '--';
        document.getElementById(`formula-protein-result-${n}`).textContent = '--';
        document.getElementById(`formula-fat-result-${n}`).textContent = '--';
        document.getElementById(`formula-carb-result-${n}`).textContent = '--';
        calculateCombinedTotal();
        return;
      }

      document.getElementById(`formula-energy-${n}`).textContent = formula.kcal + ' kcal';
      document.getElementById(`formula-protein-${n}`).textContent = formula.protein + ' g';
      document.getElementById(`formula-fat-${n}`).textContent = formula.fat + ' g';
      document.getElementById(`formula-dilution-${n}`).textContent = formula.dilution;
      infoDiv.style.display = 'block';

      calculateFormulaNutrition(n);
    }

    function calculateFormulaNutrition(n) {
      const formula = getSelectedFormula(n);
      const volume = parseFloat(document.getElementById(`formula-volume-${n}`).value);
      const strength = parseFloat(document.getElementById(`formula-strength-${n}`).value) || 1.0;
      const frequency = parseFloat(document.getElementById(`formula-freq-${n}`).value) || 1;

      if (!formula || !volume) {
        document.getElementById(`formula-kcal-result-${n}`).textContent = '--';
        document.getElementById(`formula-protein-result-${n}`).textContent = '--';
        document.getElementById(`formula-fat-result-${n}`).textContent = '--';
        document.getElementById(`formula-carb-result-${n}`).textContent = '--';
        calculateCombinedTotal();
        return;
      }

      const factor = (volume / 100) * strength * frequency;
      document.getElementById(`formula-kcal-result-${n}`).textContent = Math.round(formula.kcal * factor);
      document.getElementById(`formula-protein-result-${n}`).textContent = (formula.protein * factor).toFixed(1);
      document.getElementById(`formula-fat-result-${n}`).textContent = (formula.fat * factor).toFixed(1);
      document.getElementById(`formula-carb-result-${n}`).textContent = (formula.carbs * factor).toFixed(1);

      calculateCombinedTotal();
    }

    function calculateCombinedTotal() {
      let totalVolume = 0;
      let totalKcal = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;

      // Get values from Formula 1
      const formula1 = getSelectedFormula(1);
      const volume1 = parseFloat(document.getElementById('formula-volume-1').value) || 0;
      const strength1 = parseFloat(document.getElementById('formula-strength-1').value) || 1.0;
      const freq1 = parseFloat(document.getElementById('formula-freq-1').value) || 1;
      if (formula1 && volume1) {
        const factor1 = (volume1 / 100) * strength1 * freq1;
        totalVolume += volume1 * freq1;
        totalKcal += formula1.kcal * factor1;
        totalProtein += formula1.protein * factor1;
        totalCarbs += formula1.carbs * factor1;
        totalFat += formula1.fat * factor1;
      }

      // Get values from Formula 2
      const formula2 = getSelectedFormula(2);
      const volume2 = parseFloat(document.getElementById('formula-volume-2').value) || 0;
      const strength2 = parseFloat(document.getElementById('formula-strength-2').value) || 1.0;
      const freq2 = parseFloat(document.getElementById('formula-freq-2').value) || 1;
      if (formula2 && volume2) {
        const factor2 = (volume2 / 100) * strength2 * freq2;
        totalVolume += volume2 * freq2;
        totalKcal += formula2.kcal * factor2;
        totalProtein += formula2.protein * factor2;
        totalCarbs += formula2.carbs * factor2;
        totalFat += formula2.fat * factor2;
      }

      // Update combined display
      document.getElementById('combined-volume').textContent = totalVolume > 0 ? Math.round(totalVolume) : '--';
      document.getElementById('combined-kcal').textContent = totalKcal > 0 ? Math.round(totalKcal) : '--';
      document.getElementById('combined-protein').textContent = totalProtein > 0 ? totalProtein.toFixed(1) : '--';
      document.getElementById('combined-carbs').textContent = totalCarbs > 0 ? totalCarbs.toFixed(1) : '--';
      document.getElementById('combined-fat').textContent = totalFat > 0 ? totalFat.toFixed(1) : '--';
      document.getElementById('combined-kcal-per-100').textContent = totalVolume > 0 && totalKcal > 0
        ? Math.round(totalKcal / totalVolume * 100)
        : '--';
    }

    function parseDilution(dilutionStr) {
      // Parse dilution string to get WATER (ml) per scoop
      // "1:30ml" means 1 scoop powder + 30ml water (not final volume)
      if (!dilutionStr || dilutionStr === 'RTF' || dilutionStr === '--') return null;

      // Handle "1:30ml" format - 1 scoop + 30ml water
      const match1 = dilutionStr.match(/^1:(\d+)ml$/i);
      if (match1) return parseFloat(match1[1]);

      // Handle "7:210ml=250ml" format - 7 scoops + 210ml water = 250ml final
      // Return water per scoop: 210/7 = 30ml water per scoop
      const match2 = dilutionStr.match(/^(\d+):(\d+)ml=(\d+)ml$/i);
      if (match2) {
        const scoops = parseFloat(match2[1]);
        const waterVol = parseFloat(match2[2]); // Water added, not final volume
        return waterVol / scoops;
      }

      return null;
    }

    function calculateCustomStrength() {
      const formulaId = parseInt(document.getElementById('strength-formula-select').value);
      const formula = getFormulaById(formulaId);
      const strength = parseFloat(document.getElementById('target-strength').value);
      const targetVol = parseFloat(document.getElementById('target-volume').value);
      const dilutionFactor = parseFloat(document.getElementById('dilution-factor').value);
      const resultDiv = document.getElementById('custom-strength-result');

      if (!formula || !strength || !targetVol) {
        resultDiv.style.display = 'none';
        return;
      }

      const mlPerScoop = parseDilution(formula.dilution);

      if (!mlPerScoop) {
        document.getElementById('strength-instruction').innerHTML = formula.dilution === 'RTF'
          ? '<i class="fas fa-info-circle"></i> This is a Ready-To-Feed formula (no mixing required)'
          : '<i class="fas fa-exclamation-circle"></i> Dilution info not available for this formula';
        document.getElementById('scoops-needed').textContent = '--';
        document.getElementById('water-needed').textContent = '--';
        document.getElementById('final-kcal').textContent = '--';
        resultDiv.style.display = 'block';
        return;
      }

      // Water needed = target volume × expansion factor (0.9 or 0.84)
      // When water is divided by expansion factor, it gives the final target volume
      const waterNeeded = targetVol * dilutionFactor;

      // Calculate scoops needed based on water amount
      // At standard strength (1.0), waterNeeded ml needs (waterNeeded / mlPerScoop) scoops
      // For higher strength, multiply scoops by strength factor
      const scoopsNeeded = (waterNeeded / mlPerScoop) * strength;

      // Final kcal per 100ml
      const finalKcal = formula.kcal * strength;

      // Round scoops to 1 decimal
      const scoopsRounded = Math.round(scoopsNeeded * 10) / 10;
      const waterRounded = Math.round(waterNeeded);

      // Generate instruction
      let instruction = `<i class="fas fa-spoon"></i> ${scoopsRounded} scoop${scoopsRounded !== 1 ? 's' : ''} + ${waterRounded}mL water`;
      if (strength !== 1) {
        instruction += ` (${strength}× strength)`;
      }

      document.getElementById('strength-instruction').innerHTML = instruction;
      document.getElementById('scoops-needed').textContent = scoopsRounded;
      document.getElementById('water-needed').textContent = waterRounded + ' mL';
      document.getElementById('final-kcal').textContent = Math.round(finalKcal) + ' kcal';
      resultDiv.style.display = 'block';
    }

    function calculateReverseNutrition() {
      const formulaId = parseInt(document.getElementById('reverse-formula-select').value);
      const formula = getFormulaById(formulaId);
      const scoops = parseFloat(document.getElementById('reverse-scoops').value);
      const water = parseFloat(document.getElementById('reverse-water').value);
      const expansionFactor = parseFloat(document.getElementById('reverse-expansion').value);
      const resultDiv = document.getElementById('reverse-results');

      if (!formula || !scoops || !water) {
        resultDiv.style.display = 'none';
        return;
      }

      const mlPerScoop = parseDilution(formula.dilution);

      if (!mlPerScoop) {
        resultDiv.style.display = 'none';
        return;
      }

      // Final volume = water ÷ expansion factor
      const finalVolume = water / expansionFactor;

      // Calculate strength: actual scoops vs expected scoops for water amount
      // Expected scoops at standard strength = water / mlPerScoop
      const expectedScoops = water / mlPerScoop;
      const strength = scoops / expectedScoops;

      // Calculate nutrition based on final volume and strength
      const factor = (finalVolume / 100) * strength;

      document.getElementById('reverse-volume').textContent = Math.round(finalVolume);
      document.getElementById('reverse-strength').textContent = strength.toFixed(2) + '×';
      document.getElementById('reverse-kcal').textContent = Math.round(formula.kcal * factor);
      document.getElementById('reverse-protein').textContent = (formula.protein * factor).toFixed(1);
      document.getElementById('reverse-carbs').textContent = (formula.carbs * factor).toFixed(1);
      document.getElementById('reverse-fat').textContent = (formula.fat * factor).toFixed(1);
      resultDiv.style.display = 'block';
    }

    // Ketogenic Diet Calculator (based on Excel formulas)
    // Ketocal 4:1 per 100ml at 100% strength: 100 kcal, 9.8g fat, 2g protein, 0.4g CHO
    const ketocalBase = { kcal: 100, fat: 9.8, protein: 2.0, cho: 0.4 };
    // Nutren Junior Powder per 100ml at standard dilution: 102 kcal, 4.04g fat, 3.04g protein, 13.36g CHO
    const nutrenBase = { kcal: 102, fat: 4.04, protein: 3.04, cho: 13.36 };
    let ketoResults = { fat: 0, cho: 0, protein: 0 };

    function updateKetocalInfo() {
      const strength = parseFloat(document.getElementById('ketocal-strength').value) || 100;
      const factor = strength / 100;
      document.getElementById('ketocal-strength-display').textContent = strength;
      document.getElementById('ketocal-info-kcal').textContent = (ketocalBase.kcal * factor).toFixed(0);
      document.getElementById('ketocal-info-fat').textContent = (ketocalBase.fat * factor).toFixed(1);
      document.getElementById('ketocal-info-pro').textContent = (ketocalBase.protein * factor).toFixed(1);
      document.getElementById('ketocal-info-cho').textContent = (ketocalBase.cho * factor).toFixed(1);
    }

    function toggleAdjustmentMethod() {
      const method = document.getElementById('adjustment-method').value;
      document.getElementById('adjustment-beneprotein').style.display = method === 'beneprotein' ? 'block' : 'none';
      document.getElementById('adjustment-polycal').style.display = method === 'polycal' ? 'block' : 'none';
      document.getElementById('adjustment-nutren').style.display = method === 'nutren' ? 'block' : 'none';
      // Recalculate to update final nutrition
      calculateKetocal();
    }

    function updateNutrenInfo() {
      const strength = parseFloat(document.getElementById('nutren-strength').value) || 100;
      const factor = strength / 100;
      document.getElementById('nutren-strength-display').textContent = strength;
      document.getElementById('nutren-info-kcal').textContent = (nutrenBase.kcal * factor).toFixed(0);
      document.getElementById('nutren-info-fat').textContent = (nutrenBase.fat * factor).toFixed(2);
      document.getElementById('nutren-info-pro').textContent = (nutrenBase.protein * factor).toFixed(2);
      document.getElementById('nutren-info-cho').textContent = (nutrenBase.cho * factor).toFixed(2);
    }

    function calculateKeto() {
      const energy = parseFloat(document.getElementById('keto-energy').value);
      const protein = parseFloat(document.getElementById('keto-protein').value);
      const ratioFat = parseFloat(document.getElementById('keto-ratio-fat').value);
      const ratioPro = parseFloat(document.getElementById('keto-ratio-pro').value) || 1;
      const ratio = ratioFat / ratioPro;
      const resultDiv = document.getElementById('keto-results');
      const ketocalResultDiv = document.getElementById('ketocal-results');
      const stepsDiv = document.getElementById('keto-steps');
      const warningDiv = document.getElementById('keto-warning');

      if (!energy || !protein || !ratioFat || isNaN(ratio)) {
        resultDiv.style.display = 'none';
        ketocalResultDiv.style.display = 'none';
        return;
      }

      // Formula from Excel:
      // Energy per unit = (Fat ratio × 9) + (1 × 4)
      const energyPerUnit = (ratio * 9) + (1 * 4);

      // No. of units = Energy requirement / Energy per unit
      const numUnits = energy / energyPerUnit;

      // Amount of fat (g) = No. of units × Fat ratio
      const fatGrams = numUnits * ratio;

      // Amount of protein (g) = Protein requirement (given)
      const proteinGrams = protein;

      // Amount of CHO (g) = No. of units - Protein requirement
      const choGrams = numUnits - protein;

      // Store results
      ketoResults = { fat: fatGrams, cho: choGrams, protein: proteinGrams };

      // Build calculation steps
      const steps = `
        <div style="margin-bottom: 8px;"><strong>1. Energy per unit</strong> = (${ratio} × 9) + (1 × 4) = <strong>${energyPerUnit.toFixed(1)} kcal</strong></div>
        <div style="margin-bottom: 8px;"><strong>2. No. of units</strong> = ${energy} ÷ ${energyPerUnit.toFixed(1)} = <strong>${numUnits.toFixed(2)} units</strong></div>
        <div style="margin-bottom: 8px;"><strong>3. Fat</strong> = ${numUnits.toFixed(2)} × ${ratio} = <strong>${fatGrams.toFixed(2)}g</strong></div>
        <div style="margin-bottom: 8px;"><strong>4. Protein</strong> = <strong>${proteinGrams}g</strong> (given)</div>
        <div><strong>5. CHO</strong> = ${numUnits.toFixed(2)} − ${protein} = <strong>${choGrams.toFixed(2)}g</strong></div>
      `;
      stepsDiv.innerHTML = steps;

      // Display results
      document.getElementById('keto-result-fat').textContent = fatGrams.toFixed(1);
      document.getElementById('keto-result-protein').textContent = proteinGrams;
      document.getElementById('keto-result-cho').textContent = choGrams.toFixed(1);

      // Show warning if CHO is negative
      if (choGrams < 0) {
        warningDiv.style.display = 'block';
        document.getElementById('keto-warning-text').textContent =
          `Negative CHO (${choGrams.toFixed(1)}g) - protein requirement may be too high for this ratio. Consider lower ratio or lower protein.`;
      } else {
        warningDiv.style.display = 'none';
      }

      resultDiv.style.display = 'block';
      calculateKetocal();
    }

    function calculateKetocal() {
      const ketocalResultDiv = document.getElementById('ketocal-results');

      if (!ketoResults.fat) {
        ketocalResultDiv.style.display = 'none';
        return;
      }

      const ratioFat = parseFloat(document.getElementById('keto-ratio-fat').value);
      const ratioPro = parseFloat(document.getElementById('keto-ratio-pro').value) || 1;
      const ratio = ratioFat / ratioPro;

      // Get Ketocal strength and calculate actual values per 100ml
      const ketocalStrength = parseFloat(document.getElementById('ketocal-strength').value) || 100;
      const ketocalFactor = ketocalStrength / 100;
      const ketocal = {
        kcal: ketocalBase.kcal * ketocalFactor,
        fat: ketocalBase.fat * ketocalFactor,
        protein: ketocalBase.protein * ketocalFactor,
        cho: ketocalBase.cho * ketocalFactor
      };

      // Amount of Ketocal to fulfill fat (ml) = Fat needed / Ketocal fat per 100ml × 100
      const ketocalAmount = (ketoResults.fat / ketocal.fat) * 100;

      // Nutrients from Ketocal
      const fatFromKetocal = (ketocalAmount * ketocal.fat) / 100;
      const proteinFromKetocal = (ketocalAmount * ketocal.protein) / 100;
      const choFromKetocal = (ketocalAmount * ketocal.cho) / 100;

      // Current KD ratio from Ketocal = Fat / (Protein + CHO)
      const currentRatio = fatFromKetocal / (proteinFromKetocal + choFromKetocal);

      // Extra protein/CHO to add = (Fat from Ketocal / KD ratio) - (Protein from Ketocal + CHO from Ketocal)
      const extraProCho = (fatFromKetocal / ratio) - (proteinFromKetocal + choFromKetocal);

      // Option A: Use EITHER Beneprotein OR Polycal (not both!)
      // Beneprotein: provides Extra grams of protein (7g powder = 6g protein)
      const beneprotein = extraProCho * 7 / 6;
      // Polycal: provides Extra grams of CHO (1g powder = 0.96g CHO)
      const polycal = extraProCho / 0.96;

      // Option B: Nutren Junior Powder calculation
      // Nutren adds fat too, so we need a different formula to achieve target ratio
      // Formula: x = 100 × (F - R × (P + C)) / (R × (n_p + n_c) - n_f)
      // where x = ml of Nutren, F = fat from Ketocal, R = target ratio
      const nutrenStrength = parseFloat(document.getElementById('nutren-strength').value) || 100;
      const nutrenFactor = nutrenStrength / 100;
      const nutren = {
        fat: nutrenBase.fat * nutrenFactor,
        protein: nutrenBase.protein * nutrenFactor,
        cho: nutrenBase.cho * nutrenFactor
      };
      updateNutrenInfo();

      // Calculate Nutren amount accounting for its fat content
      const nutrenProChoPer100ml = nutren.protein + nutren.cho;
      const nutrenFatPer100ml = nutren.fat;
      const denominator = (ratio * nutrenProChoPer100ml) - nutrenFatPer100ml;
      let nutrenAmount = 0;
      if (denominator > 0) {
        nutrenAmount = 100 * (fatFromKetocal - ratio * (proteinFromKetocal + choFromKetocal)) / denominator;
      }

      // Display results
      document.getElementById('ketocal-amount').textContent = ketocalAmount.toFixed(1);
      document.getElementById('ketocal-fat').textContent = fatFromKetocal.toFixed(1);
      document.getElementById('ketocal-protein').textContent = proteinFromKetocal.toFixed(1);
      document.getElementById('ketocal-cho').textContent = choFromKetocal.toFixed(1);
      document.getElementById('ketocal-ratio').textContent = currentRatio.toFixed(2) + ':1';
      document.getElementById('ketocal-extra').textContent = extraProCho.toFixed(1);
      document.getElementById('ketocal-beneprotein').textContent = beneprotein.toFixed(1);
      document.getElementById('ketocal-polycal').textContent = polycal.toFixed(1);
      document.getElementById('ketocal-nutren').textContent = nutrenAmount.toFixed(1);

      ketocalResultDiv.style.display = 'block';

      // Calculate final combined nutrition based on selected adjustment method
      const adjustmentMethod = document.getElementById('adjustment-method').value;
      let finalKcal = (ketocalAmount * ketocal.kcal) / 100;
      let finalFat = fatFromKetocal;
      let finalProtein = proteinFromKetocal;
      let finalCho = choFromKetocal;
      let finalVolume = ketocalAmount;
      let compositionText = '';

      if (adjustmentMethod === 'beneprotein') {
        // Beneprotein: 7g powder = 6g protein, ~25 kcal per 7g (3.6 kcal/g)
        const beneproteinKcal = beneprotein * 3.6;
        const beneproteinProtein = beneprotein * 6 / 7;
        finalKcal += beneproteinKcal;
        finalProtein += beneproteinProtein;
        compositionText = `Ketocal ${ketocalAmount.toFixed(1)}ml + Beneprotein ${beneprotein.toFixed(1)}g`;
      } else if (adjustmentMethod === 'polycal') {
        // Polycal: 1g powder = 0.96g CHO, 3.84 kcal/g
        const polycalKcal = polycal * 3.84;
        const polycalCho = polycal * 0.96;
        finalKcal += polycalKcal;
        finalCho += polycalCho;
        compositionText = `Ketocal ${ketocalAmount.toFixed(1)}ml + Polycal ${polycal.toFixed(1)}g`;
      } else if (adjustmentMethod === 'nutren') {
        // Nutren Junior Powder contributes kcal, fat, protein, CHO
        const nutrenKcalFactor = nutrenStrength / 100;
        const nutrenKcalPer100ml = nutrenBase.kcal * nutrenKcalFactor;
        const nutrenKcalAdded = (nutrenAmount * nutrenKcalPer100ml) / 100;
        const nutrenFatAdded = (nutrenAmount * nutren.fat) / 100;
        const nutrenProteinAdded = (nutrenAmount * nutren.protein) / 100;
        const nutrenChoAdded = (nutrenAmount * nutren.cho) / 100;
        finalKcal += nutrenKcalAdded;
        finalFat += nutrenFatAdded;
        finalProtein += nutrenProteinAdded;
        finalCho += nutrenChoAdded;
        finalVolume += nutrenAmount;
        compositionText = `Ketocal ${ketocalAmount.toFixed(1)}ml + Nutren Junior ${nutrenAmount.toFixed(1)}ml`;
      }

      // Calculate achieved KD ratio
      const achievedRatio = finalFat / (finalProtein + finalCho);

      // Display final nutrition
      document.getElementById('keto-final-kcal').textContent = finalKcal.toFixed(0);
      document.getElementById('keto-final-fat').textContent = finalFat.toFixed(1);
      document.getElementById('keto-final-protein').textContent = finalProtein.toFixed(1);
      document.getElementById('keto-final-cho').textContent = finalCho.toFixed(1);
      document.getElementById('keto-final-volume').textContent = finalVolume.toFixed(1);
      document.getElementById('keto-final-ratio').textContent = achievedRatio.toFixed(2) + ':1';
      document.getElementById('keto-final-composition').textContent = compositionText;
      document.getElementById('keto-final-nutrition').style.display = 'block';

      // Check if final protein is below requirement
      const proteinRequirement = ketoResults.protein;
      const proteinWarningDiv = document.getElementById('keto-protein-warning');
      if (finalProtein < proteinRequirement) {
        const deficit = proteinRequirement - finalProtein;
        document.getElementById('keto-protein-warning-text').textContent =
          `Protein (${finalProtein.toFixed(1)}g) is below requirement (${proteinRequirement}g) by ${deficit.toFixed(1)}g`;
        proteinWarningDiv.style.display = 'block';
      } else {
        proteinWarningDiv.style.display = 'none';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      populateSupplementDropdown();
      populateFormulaDropdown();
    });
    document.getElementById('edit-modal').addEventListener('click', e => { if (e.target === document.getElementById('edit-modal')) closeModal(); });
  </script>
</body>
</html>
